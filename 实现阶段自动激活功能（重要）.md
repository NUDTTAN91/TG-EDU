# å®ç°é˜¶æ®µè‡ªåŠ¨æ¿€æ´»åŠŸèƒ½ï¼ˆé‡è¦ï¼‰

## åŠŸèƒ½éœ€æ±‚

å®ç°å¤§ä½œä¸šé˜¶æ®µçš„è‡ªåŠ¨çŠ¶æ€ç®¡ç†ï¼š
- å½“é˜¶æ®µåˆ°è¾¾ `start_date` æ—¶ï¼Œè‡ªåŠ¨å°†çŠ¶æ€ä» `pending` å˜ä¸º `active`
- å½“é˜¶æ®µåˆ°è¾¾ `end_date` æ—¶ï¼Œè‡ªåŠ¨å°†çŠ¶æ€ä» `active` å˜ä¸º `completed`

## å®ç°æ–¹æ¡ˆ

é‡‡ç”¨**å®šæ—¶ä»»åŠ¡**æ–¹æ¡ˆï¼Œæ¯åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥æ‰€æœ‰é˜¶æ®µçŠ¶æ€å¹¶æ›´æ–°ã€‚

---

## å®ç°æ­¥éª¤

### 1. æ·»åŠ ä¾èµ–åŒ…

åœ¨ `requirements.txt` ä¸­æ·»åŠ å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨ï¼š

```txt
Flask-APScheduler==1.13.1
```

### 2. åˆ›å»ºè°ƒåº¦å™¨æœåŠ¡

åˆ›å»ºæ–‡ä»¶ï¼š`app/services/scheduler_service.py`

```python
"""å®šæ—¶ä»»åŠ¡æœåŠ¡ - è‡ªåŠ¨æ›´æ–°é˜¶æ®µçŠ¶æ€"""
from flask_apscheduler import APScheduler
from app.services.stage_service import StageService
import os


scheduler = APScheduler()


def init_scheduler(app):
    """åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨"""
    # åªåœ¨ç¬¬ä¸€ä¸ªworkerä¸­å¯åŠ¨è°ƒåº¦å™¨
    # ä½¿ç”¨ç¯å¢ƒå˜é‡æ¥æ§åˆ¶ï¼Œé¿å…å¤šä¸ªworkeré‡å¤å¯åŠ¨
    import os
    import time
    import sys
    
    # æ£€æŸ¥æ˜¯å¦æ˜¯è¿ç§»è„šæœ¬ï¼ˆä¸å¯åŠ¨è°ƒåº¦å™¨ï¼‰
    script_name = os.path.basename(sys.argv[0] if sys.argv else '')
    if script_name.startswith('migrate_') or script_name in ['init_db.py', 'update_stage_status.py']:
        return
    
    # æ£€æŸ¥æ˜¯å¦å·²æœ‰å…¶ä»–workerå¯åŠ¨äº†è°ƒåº¦å™¨
    scheduler_lock_file = '/tmp/tg_edu_scheduler_flask.lock'
    current_pid = os.getpid()
    
    try:
        # å¦‚æœé”æ–‡ä»¶å·²å­˜åœ¨ï¼Œæ£€æŸ¥å…¶åˆ›å»ºæ—¶é—´
        if os.path.exists(scheduler_lock_file):
            # æ£€æŸ¥é”æ–‡ä»¶æ˜¯å¦æ˜¯æœ€è¿‘30ç§’å†…åˆ›å»ºçš„ï¼ˆåŒä¸€æ‰¹workerï¼‰
            lock_age = time.time() - os.path.getmtime(scheduler_lock_file)
            if lock_age < 30:  # 30ç§’å†…
                with open(scheduler_lock_file, 'r') as f:
                    lock_pid = f.read().strip()
                print(f"âš ï¸  Worker {current_pid}: è°ƒåº¦å™¨å·²åœ¨Worker {lock_pid}ä¸­å¯åŠ¨ï¼Œè·³è¿‡")
                return
            else:
                # è¿‡æœŸçš„é”ï¼Œåˆ é™¤å®ƒï¼ˆå¯èƒ½æ˜¯ä¸Šæ¬¡è¿è¡Œç•™ä¸‹çš„ï¼‰
                os.remove(scheduler_lock_file)
        
        # åˆ›å»ºé”æ–‡ä»¶ï¼Œå†™å…¥å½“å‰è¿›ç¨‹ID
        with open(scheduler_lock_file, 'w') as f:
            f.write(str(current_pid))
    except Exception as e:
        print(f"âŒ åˆ›å»ºè°ƒåº¦å™¨é”æ–‡ä»¶å¤±è´¥: {e}")
        return
    
    # é…ç½®è°ƒåº¦å™¨
    app.config['SCHEDULER_API_ENABLED'] = False  # ç¦ç”¨APIï¼Œæé«˜å®‰å…¨æ€§
    
    scheduler.init_app(app)
    
    # æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼šæ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡é˜¶æ®µçŠ¶æ€
    @scheduler.task('interval', id='update_stage_status', minutes=1, misfire_grace_time=900)
    def scheduled_stage_update():
        """å®šæ—¶æ›´æ–°é˜¶æ®µçŠ¶æ€"""
        with app.app_context():
            try:
                print("â° å®šæ—¶ä»»åŠ¡ï¼šå¼€å§‹æ›´æ–°é˜¶æ®µçŠ¶æ€...")
                StageService.check_and_update_stages()
                print("âœ… å®šæ—¶ä»»åŠ¡ï¼šé˜¶æ®µçŠ¶æ€æ›´æ–°å®Œæˆ")
            except Exception as e:
                print(f"âŒ å®šæ—¶ä»»åŠ¡ï¼šé˜¶æ®µçŠ¶æ€æ›´æ–°å¤±è´¥ - {str(e)}")
                import traceback
                traceback.print_exc()
    
    # å¯åŠ¨è°ƒåº¦å™¨
    scheduler.start()
    print(f"ğŸš€ Worker {current_pid}: å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨å·²å¯åŠ¨")
```

**å…³é”®ç‚¹è¯´æ˜**ï¼š

1. **è¿‡æ»¤è¿ç§»è„šæœ¬**ï¼šæ£€æŸ¥ `sys.argv[0]` ç¡®ä¿ä¸åœ¨è¿ç§»è„šæœ¬ä¸­å¯åŠ¨è°ƒåº¦å™¨
2. **é”æ–‡ä»¶æœºåˆ¶**ï¼šä½¿ç”¨ `/tmp/tg_edu_scheduler_flask.lock` ç¡®ä¿åªæœ‰ä¸€ä¸ªworkerå¯åŠ¨è°ƒåº¦å™¨
3. **æ—¶æ•ˆæ€§æ£€æŸ¥**ï¼šé”æ–‡ä»¶30ç§’å†…æœ‰æ•ˆï¼Œè¶…æ—¶è‡ªåŠ¨åˆ é™¤
4. **åº”ç”¨ä¸Šä¸‹æ–‡**ï¼šä½¿ç”¨ `with app.app_context()` ç¡®ä¿å¯ä»¥è®¿é—®æ•°æ®åº“
5. **å¼‚å¸¸å¤„ç†**ï¼šå®Œæ•´çš„é”™è¯¯æ•è·å’Œæ—¥å¿—è¾“å‡º

### 3. åœ¨åº”ç”¨åˆå§‹åŒ–æ—¶å¯åŠ¨è°ƒåº¦å™¨

ä¿®æ”¹ `app/__init__.py`ï¼š

```python
def create_app(config_name='default'):
    """åˆ›å»ºFlaskåº”ç”¨å®ä¾‹"""
    app = Flask(__name__)
    
    # åŠ è½½é…ç½®
    app.config.from_object(config[config_name])
    
    # ç¡®ä¿å¿…è¦çš„ç›®å½•å­˜åœ¨
    os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)
    os.makedirs(os.path.join(app.config['STORAGE_DIR'], 'data'), exist_ok=True)
    os.makedirs(app.config['APPENDIX_FOLDER'], exist_ok=True)
    
    # åˆå§‹åŒ–æ‰©å±•
    init_extensions(app)
    
    # æ³¨å†Œuser_loader
    @login_manager.user_loader
    def load_user(user_id):
        return User.query.get(int(user_id))
    
    # æ³¨å†ŒJinja2è¿‡æ»¤å™¨
    register_filters(app)
    
    # æ³¨å†Œä¸Šä¸‹æ–‡å¤„ç†å™¨
    register_context_processors(app)
    
    # æ³¨å†Œè“å›¾
    register_blueprints(app)
    
    # åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨  # <-- æ–°å¢
    init_scheduler(app)  # <-- æ–°å¢
    
    return app


def init_scheduler(app):  # <-- æ–°å¢å‡½æ•°
    """åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨"""
    from app.services.scheduler_service import init_scheduler as _init_scheduler
    _init_scheduler(app)
```

### 4. æ¸…ç†å¯åŠ¨è„šæœ¬ä¸­çš„æ—§é”æ–‡ä»¶

ä¿®æ”¹ `start.sh`ï¼Œåœ¨å¯åŠ¨Gunicornå‰æ¸…ç†æ—§é”æ–‡ä»¶ï¼š

```bash
echo "å¯åŠ¨WebæœåŠ¡å™¨..."
# æ¸…ç†æ—§çš„è°ƒåº¦å™¨é”æ–‡ä»¶
rm -f /tmp/tg_edu_scheduler_flask.lock

# ä¼˜åŒ–é…ç½®ï¼š
# - workers: æ ¹æ®CPUæ ¸å¿ƒæ•°è®¾ç½® (2 * CPUæ ¸å¿ƒæ•° + 1)
# - worker-class: ä½¿ç”¨geventå¼‚æ­¥workeræé«˜å¹¶å‘èƒ½åŠ›
# - timeout: é™ä½è¶…æ—¶æ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´å ç”¨worker
# - max-requests: å®šæœŸé‡å¯workerï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
# - max-requests-jitter: æ·»åŠ éšæœºæŠ–åŠ¨ï¼Œé¿å…æ‰€æœ‰workeråŒæ—¶é‡å¯
exec gunicorn --bind 0.0.0.0:5000 \
    --workers 8 \
    --worker-class gevent \
    --worker-connections 1000 \
    --timeout 120 \
    --max-requests 1000 \
    --max-requests-jitter 100 \
    --access-logfile - \
    --error-logfile - \
    wsgi:app
```

---

## é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šå¤šä¸ªWorkeré‡å¤æ‰§è¡Œå®šæ—¶ä»»åŠ¡

**é—®é¢˜æè¿°**ï¼š
- é¡¹ç›®ä½¿ç”¨ Gunicorn è¿è¡Œï¼Œé…ç½®äº†8ä¸ªworkerè¿›ç¨‹
- æ¯ä¸ªworkeréƒ½ä¼šè°ƒç”¨ `create_app()`ï¼Œå¯¼è‡´æ¯ä¸ªworkeréƒ½å¯åŠ¨äº†è°ƒåº¦å™¨
- ç»“æœï¼šå®šæ—¶ä»»åŠ¡è¢«æ‰§è¡Œäº†8æ¬¡ï¼

**è¡¨ç°**ï¼š
```
ğŸš€ Worker 17: å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨å·²å¯åŠ¨
ğŸš€ Worker 21: å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨å·²å¯åŠ¨
ğŸš€ Worker 26: å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨å·²å¯åŠ¨
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

ä½¿ç”¨**é”æ–‡ä»¶æœºåˆ¶**ï¼Œè®©ç¬¬ä¸€ä¸ªworkeråˆ›å»ºé”æ–‡ä»¶å¹¶å¯åŠ¨è°ƒåº¦å™¨ï¼Œå…¶ä»–workeræ£€æµ‹åˆ°é”æ–‡ä»¶å­˜åœ¨åè·³è¿‡åˆå§‹åŒ–ï¼š

```python
scheduler_lock_file = '/tmp/tg_edu_scheduler_flask.lock'

if os.path.exists(scheduler_lock_file):
    lock_age = time.time() - os.path.getmtime(scheduler_lock_file)
    if lock_age < 30:  # é”æ–‡ä»¶ä»ç„¶æœ‰æ•ˆ
        print(f"âš ï¸  Worker {current_pid}: è°ƒåº¦å™¨å·²åœ¨å…¶ä»–workerä¸­å¯åŠ¨ï¼Œè·³è¿‡")
        return
```

**æ•ˆæœ**ï¼š
```
ğŸš€ Worker 27: å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨å·²å¯åŠ¨
âš ï¸  Worker 28: è°ƒåº¦å™¨å·²åœ¨Worker 27ä¸­å¯åŠ¨ï¼Œè·³è¿‡
âš ï¸  Worker 29: è°ƒåº¦å™¨å·²åœ¨Worker 27ä¸­å¯åŠ¨ï¼Œè·³è¿‡
âš ï¸  Worker 30: è°ƒåº¦å™¨å·²åœ¨Worker 27ä¸­å¯åŠ¨ï¼Œè·³è¿‡
```

### é—®é¢˜2ï¼šè¿ç§»è„šæœ¬ä¹Ÿå¯åŠ¨äº†è°ƒåº¦å™¨

**é—®é¢˜æè¿°**ï¼š
- å¯åŠ¨è„šæœ¬ `start.sh` åœ¨å¯åŠ¨Gunicornä¹‹å‰ä¼šè¿è¡Œå¤šä¸ªæ•°æ®åº“è¿ç§»è„šæœ¬
- è¿™äº›è¿ç§»è„šæœ¬ä¹Ÿè°ƒç”¨äº† `create_app()`ï¼Œå¯¼è‡´ç¬¬ä¸€ä¸ªåˆ›å»ºé”æ–‡ä»¶çš„æ˜¯è¿ç§»è„šæœ¬ï¼ˆPID 7ï¼‰
- è¿ç§»è„šæœ¬æ‰§è¡Œå®Œå°±é€€å‡ºäº†ï¼Œè°ƒåº¦å™¨ä¹Ÿéšä¹‹åœæ­¢
- åç»­çš„Gunicorn workersçœ‹åˆ°é”æ–‡ä»¶å­˜åœ¨ï¼Œéƒ½è·³è¿‡äº†è°ƒåº¦å™¨å¯åŠ¨
- **ç»“æœ**ï¼šæ²¡æœ‰ä»»ä½•workerè¿è¡Œè°ƒåº¦å™¨ï¼

**é—®é¢˜åŸå› **ï¼š
```bash
# start.sh æ‰§è¡Œé¡ºåº
python3 migrate_db.py              # PID 7ï¼Œåˆ›å»ºé”æ–‡ä»¶ï¼Œå¯åŠ¨è°ƒåº¦å™¨
python3 migrate_stage_system.py   # PID 11ï¼Œçœ‹åˆ°é”æ–‡ä»¶ï¼Œè·³è¿‡
...
gunicorn ...                       # PID 27-34ï¼Œå…¨éƒ¨çœ‹åˆ°é”æ–‡ä»¶ï¼Œå…¨éƒ¨è·³è¿‡
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

åœ¨è°ƒåº¦å™¨åˆå§‹åŒ–æ—¶ï¼Œæ£€æŸ¥å½“å‰è¿è¡Œçš„æ˜¯å¦æ˜¯è¿ç§»è„šæœ¬ï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥è¿”å›ï¼š

```python
# æ£€æŸ¥æ˜¯å¦æ˜¯è¿ç§»è„šæœ¬ï¼ˆä¸å¯åŠ¨è°ƒåº¦å™¨ï¼‰
script_name = os.path.basename(sys.argv[0] if sys.argv else '')
if script_name.startswith('migrate_') or script_name in ['init_db.py', 'update_stage_status.py']:
    return  # è¿ç§»è„šæœ¬ç›´æ¥è¿”å›ï¼Œä¸åˆå§‹åŒ–è°ƒåº¦å™¨
```

**æ•ˆæœ**ï¼š
- è¿ç§»è„šæœ¬ï¼šæ£€æµ‹åˆ°è„šæœ¬åï¼Œè·³è¿‡è°ƒåº¦å™¨åˆå§‹åŒ– âœ…
- Gunicorn workersï¼šç¬¬ä¸€ä¸ªworkeråˆ›å»ºé”æ–‡ä»¶å¹¶å¯åŠ¨è°ƒåº¦å™¨ âœ…

### é—®é¢˜3ï¼šå®¹å™¨é‡å¯åæ—§é”æ–‡ä»¶æ®‹ç•™

**é—®é¢˜æè¿°**ï¼š
- å®¹å™¨é‡å¯æ—¶ï¼Œ`/tmp` ç›®å½•å¯èƒ½ä¿ç•™æ—§çš„é”æ–‡ä»¶
- æ–°å¯åŠ¨çš„workersæ£€æµ‹åˆ°é”æ–‡ä»¶å­˜åœ¨ï¼ˆä½†å®é™…ä¸Šå·²ç»è¿‡æœŸï¼‰
- å¦‚æœé”æ–‡ä»¶åœ¨30ç§’å†…ï¼Œæ‰€æœ‰workerséƒ½ä¼šè·³è¿‡è°ƒåº¦å™¨å¯åŠ¨

**è§£å†³æ–¹æ¡ˆ**ï¼š

åœ¨å¯åŠ¨Gunicornå‰æ¸…ç†æ—§é”æ–‡ä»¶ï¼š

```bash
# start.sh
echo "å¯åŠ¨WebæœåŠ¡å™¨..."
# æ¸…ç†æ—§çš„è°ƒåº¦å™¨é”æ–‡ä»¶
rm -f /tmp/tg_edu_scheduler_flask.lock

exec gunicorn ...
```

---

## æœ€ç»ˆå®ç°æ•ˆæœ

### æ‰§è¡Œæµç¨‹

1. **å®¹å™¨å¯åŠ¨** â†’ æ¸…ç†æ—§é”æ–‡ä»¶ (`rm -f /tmp/tg_edu_scheduler_flask.lock`)
2. **è¿è¡Œè¿ç§»è„šæœ¬** â†’ æ£€æµ‹åˆ°æ˜¯è¿ç§»è„šæœ¬ â†’ è·³è¿‡è°ƒåº¦å™¨åˆå§‹åŒ–
3. **å¯åŠ¨Gunicorn** â†’ 8ä¸ªworkersä¾æ¬¡å¯åŠ¨
4. **Worker 27ï¼ˆç¬¬ä¸€ä¸ªï¼‰** â†’ åˆ›å»ºé”æ–‡ä»¶ â†’ å¯åŠ¨è°ƒåº¦å™¨ âœ…
5. **Worker 28-34** â†’ çœ‹åˆ°é”æ–‡ä»¶å­˜åœ¨ â†’ è·³è¿‡è°ƒåº¦å™¨åˆå§‹åŒ– â­ï¸
6. **å®šæ—¶ä»»åŠ¡è¿è¡Œ** â†’ æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ `StageService.check_and_update_stages()` â†’ è‡ªåŠ¨æ›´æ–°é˜¶æ®µçŠ¶æ€

### æ—¥å¿—éªŒè¯

```
æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“...
æ•°æ®åº“è¡¨åˆ›å»ºå®Œæˆ
...
âœ… æ•°æ®åº“è¿ç§»å®Œæˆï¼
ğŸš€ Worker 27: å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨å·²å¯åŠ¨  # <-- åªæœ‰ä¸€ä¸ªworkerå¯åŠ¨
âš ï¸  Worker 28: è°ƒåº¦å™¨å·²åœ¨Worker 27ä¸­å¯åŠ¨ï¼Œè·³è¿‡
âš ï¸  Worker 29: è°ƒåº¦å™¨å·²åœ¨Worker 27ä¸­å¯åŠ¨ï¼Œè·³è¿‡
âš ï¸  Worker 30: è°ƒåº¦å™¨å·²åœ¨Worker 27ä¸­å¯åŠ¨ï¼Œè·³è¿‡
âš ï¸  Worker 31: è°ƒåº¦å™¨å·²åœ¨Worker 27ä¸­å¯åŠ¨ï¼Œè·³è¿‡
âš ï¸  Worker 32: è°ƒåº¦å™¨å·²åœ¨Worker 27ä¸­å¯åŠ¨ï¼Œè·³è¿‡
âš ï¸  Worker 33: è°ƒåº¦å™¨å·²åœ¨Worker 27ä¸­å¯åŠ¨ï¼Œè·³è¿‡
âš ï¸  Worker 34: è°ƒåº¦å™¨å·²åœ¨Worker 27ä¸­å¯åŠ¨ï¼Œè·³è¿‡
å¯åŠ¨WebæœåŠ¡å™¨...
[2025-10-21 16:38:57 +0800] [1] [INFO] Starting gunicorn 21.2.0
[2025-10-21 16:38:57 +0800] [1] [INFO] Listening at: http://0.0.0.0:5000 (1)
[2025-10-21 16:38:57 +0800] [1] [INFO] Using worker: gevent
```

### åŠŸèƒ½éªŒè¯

1. **é”æ–‡ä»¶åˆ›å»º**ï¼š
   ```bash
   $ docker exec tg-edu-system cat /tmp/tg_edu_scheduler_flask.lock
   27
   ```

2. **åªæœ‰ä¸€ä¸ªè°ƒåº¦å™¨è¿è¡Œ**ï¼š
   ```bash
   $ docker logs tg-edu-system 2>&1 | grep "ğŸš€"
   ğŸš€ Worker 27: å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨å·²å¯åŠ¨
   ```

3. **å®šæ—¶ä»»åŠ¡æ‰§è¡Œ**ï¼ˆæ¯åˆ†é’Ÿä¸€æ¬¡ï¼‰ï¼š
   ```
   â° å®šæ—¶ä»»åŠ¡ï¼šå¼€å§‹æ›´æ–°é˜¶æ®µçŠ¶æ€...
   âœ… å®šæ—¶ä»»åŠ¡ï¼šé˜¶æ®µçŠ¶æ€æ›´æ–°å®Œæˆ
   ```

---

## æŠ€æœ¯è¦ç‚¹æ€»ç»“

### 1. Flask-APScheduler ä½¿ç”¨

```python
from flask_apscheduler import APScheduler

scheduler = APScheduler()
scheduler.init_app(app)

# å®šä¹‰å®šæ—¶ä»»åŠ¡
@scheduler.task('interval', id='task_id', minutes=1)
def my_task():
    with app.app_context():
        # ä»»åŠ¡ä»£ç 
        pass

scheduler.start()
```

**å…³é”®é…ç½®**ï¼š
- `interval`ï¼šé—´éš”æ‰§è¡Œ
- `minutes=1`ï¼šæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
- `misfire_grace_time=900`ï¼šå…è®¸15åˆ†é’Ÿçš„å»¶è¿Ÿå®¹é”™
- `app.app_context()`ï¼šç¡®ä¿å¯ä»¥è®¿é—®æ•°æ®åº“

### 2. é”æ–‡ä»¶æœºåˆ¶

**åŸç†**ï¼šåˆ©ç”¨æ–‡ä»¶ç³»ç»Ÿçš„åŸå­æ€§æ“ä½œé˜²æ­¢å¹¶å‘é—®é¢˜

```python
lock_file = '/tmp/tg_edu_scheduler_flask.lock'

# æ£€æŸ¥é”
if os.path.exists(lock_file):
    lock_age = time.time() - os.path.getmtime(lock_file)
    if lock_age < 30:  # æœ‰æ•ˆæœŸå†…
        return  # è·³è¿‡

# åˆ›å»ºé”
with open(lock_file, 'w') as f:
    f.write(str(os.getpid()))
```

**ä¼˜ç‚¹**ï¼š
- ç®€å•å¯é 
- è·¨è¿›ç¨‹æœ‰æ•ˆ
- è‡ªåŠ¨æ¸…ç†ï¼ˆé€šè¿‡æ—¶æ•ˆæ€§æ£€æŸ¥ï¼‰

### 3. è¿›ç¨‹è¿‡æ»¤æŠ€å·§

**æ–¹æ³•1**ï¼šæ£€æŸ¥è„šæœ¬åç§°

```python
script_name = os.path.basename(sys.argv[0])
if script_name.startswith('migrate_'):
    return  # è·³è¿‡è¿ç§»è„šæœ¬
```

**æ–¹æ³•2**ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡ï¼ˆæœªé‡‡ç”¨ï¼‰

```python
if os.environ.get('WORKER_CLASS') == 'gevent':
    # æ˜¯gunicorn worker
    pass
```

### 4. åº”ç”¨ä¸Šä¸‹æ–‡ç®¡ç†

åœ¨å®šæ—¶ä»»åŠ¡ä¸­è®¿é—®æ•°æ®åº“å¿…é¡»ä½¿ç”¨åº”ç”¨ä¸Šä¸‹æ–‡ï¼š

```python
@scheduler.task('interval', minutes=1)
def my_task():
    with app.app_context():  # å¿…é¡»ï¼
        # è¿™é‡Œå¯ä»¥è®¿é—® db.session
        StageService.check_and_update_stages()
```

---

## éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [x] æ·»åŠ  `Flask-APScheduler==1.13.1` åˆ° `requirements.txt`
- [x] åˆ›å»º `app/services/scheduler_service.py`
- [x] åœ¨ `app/__init__.py` ä¸­è°ƒç”¨ `init_scheduler(app)`
- [x] åœ¨ `start.sh` ä¸­æ·»åŠ  `rm -f /tmp/tg_edu_scheduler_flask.lock`
- [x] åœ¨ `scheduler_service.py` ä¸­è¿‡æ»¤è¿ç§»è„šæœ¬
- [x] é…ç½®é”æ–‡ä»¶æœºåˆ¶é˜²æ­¢é‡å¤æ‰§è¡Œ
- [x] ä½¿ç”¨ `docker-compose build --no-cache` é‡æ–°æ„å»º
- [x] ä½¿ç”¨ `docker-compose up -d` å¯åŠ¨æœåŠ¡
- [x] æ£€æŸ¥æ—¥å¿—ç¡®è®¤åªæœ‰ä¸€ä¸ªworkerå¯åŠ¨äº†è°ƒåº¦å™¨

---

## ç›¸å…³æ–‡ä»¶æ¸…å•

1. **æ–°å¢æ–‡ä»¶**ï¼š
   - `app/services/scheduler_service.py` - è°ƒåº¦å™¨æœåŠ¡

2. **ä¿®æ”¹æ–‡ä»¶**ï¼š
   - `requirements.txt` - æ·»åŠ  Flask-APScheduler ä¾èµ–
   - `app/__init__.py` - è°ƒç”¨è°ƒåº¦å™¨åˆå§‹åŒ–
   - `start.sh` - æ¸…ç†æ—§é”æ–‡ä»¶

3. **ä¾èµ–æ–‡ä»¶**ï¼ˆå·²å­˜åœ¨ï¼‰ï¼š
   - `app/services/stage_service.py` - æä¾› `check_and_update_stages()` æ–¹æ³•
   - `app/models/team.py` - å®šä¹‰ Stage æ¨¡å‹

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### Q1: å®šæ—¶ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œï¼Ÿ

**æ£€æŸ¥æ­¥éª¤**ï¼š
1. æŸ¥çœ‹æ—¥å¿—æ˜¯å¦æœ‰ "ğŸš€ Worker X: å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨å·²å¯åŠ¨"
2. æ£€æŸ¥é”æ–‡ä»¶ï¼š`docker exec tg-edu-system cat /tmp/tg_edu_scheduler_flask.lock`
3. æŸ¥çœ‹æ˜¯å¦æœ‰ "â° å®šæ—¶ä»»åŠ¡ï¼šå¼€å§‹æ›´æ–°é˜¶æ®µçŠ¶æ€..." æ—¥å¿—
4. æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—ï¼š"âŒ å®šæ—¶ä»»åŠ¡ï¼šé˜¶æ®µçŠ¶æ€æ›´æ–°å¤±è´¥"

### Q2: å¤šä¸ªworkeréƒ½å¯åŠ¨äº†è°ƒåº¦å™¨ï¼Ÿ

**æ£€æŸ¥æ­¥éª¤**ï¼š
1. æœç´¢æ—¥å¿—ï¼š`docker logs tg-edu-system 2>&1 | grep "ğŸš€"`
2. å¦‚æœçœ‹åˆ°å¤šä¸ª "ğŸš€"ï¼Œè¯´æ˜é”æ–‡ä»¶æœºåˆ¶å¤±æ•ˆ
3. æ£€æŸ¥ `scheduler_service.py` ä¸­çš„é”æ–‡ä»¶é€»è¾‘
4. ç¡®è®¤ `start.sh` ä¸­æœ‰æ¸…ç†é”æ–‡ä»¶çš„å‘½ä»¤

### Q3: æ‰€æœ‰workeréƒ½è·³è¿‡äº†è°ƒåº¦å™¨ï¼Ÿ

**æ£€æŸ¥æ­¥éª¤**ï¼š
1. æœç´¢æ—¥å¿—ï¼š`docker logs tg-edu-system 2>&1 | grep "è°ƒåº¦"`
2. å¦‚æœå…¨æ˜¯ "âš ï¸ è·³è¿‡"ï¼Œå¯èƒ½æ˜¯è¿ç§»è„šæœ¬åˆ›å»ºäº†é”æ–‡ä»¶
3. æ£€æŸ¥ `scheduler_service.py` ä¸­æ˜¯å¦è¿‡æ»¤äº†è¿ç§»è„šæœ¬
4. ç¡®è®¤ `start.sh` åœ¨å¯åŠ¨Gunicornå‰æ¸…ç†äº†é”æ–‡ä»¶

---

## æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **åˆ†å¸ƒå¼é”**ï¼šå¦‚æœä½¿ç”¨å¤šå°æœåŠ¡å™¨ï¼Œéœ€è¦ä½¿ç”¨Redisç­‰åˆ†å¸ƒå¼é”
2. **å¥åº·æ£€æŸ¥**ï¼šå®šæœŸæ£€æŸ¥è°ƒåº¦å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
3. **ç›‘æ§å‘Šè­¦**ï¼šå®šæ—¶ä»»åŠ¡å¤±è´¥æ—¶å‘é€å‘Šè­¦
4. **å¯é…ç½®æ€§**ï¼šå°†æ£€æŸ¥é—´éš”æ—¶é—´é…ç½®åŒ–ï¼Œæ”¯æŒåŠ¨æ€è°ƒæ•´
5. **ä¼˜é›…åœæœº**ï¼šå®¹å™¨åœæ­¢æ—¶æ­£ç¡®å…³é—­è°ƒåº¦å™¨

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**ï¼š2025-10-21  
**ä½œè€…**ï¼šAI Assistant  
**ç‰ˆæœ¬**ï¼šv1.0
