{% extends "base.html" %}

{% block title %}补交申请管理{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面头部 -->
    <div class="hero-section mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-6 fw-bold mb-2 fade-in-up">
                    <i class="fas fa-tasks me-3" style="color: var(--accent-color);"></i>
                    补交申请管理
                </h1>
                <p class="lead mb-0 fade-in-up" style="animation-delay: 0.2s;">
                    审批学生的补交申请
                </p>
            </div>
            <div class="col-md-4 text-end">
                <button type="button" class="btn btn-success" id="batchApproveBtn" disabled>
                    <i class="fas fa-check-double me-1"></i>
                    批量批准
                </button>
            </div>
        </div>
    </div>

    <!-- 筛选器 -->
    <div class="card mb-4">
        <div class="card-body py-3">
            <div class="d-flex gap-2">
                <a href="{{ url_for('makeup.manage_requests', status='all') }}" 
                   class="btn {% if current_status == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    <i class="fas fa-list me-1"></i>全部
                </a>
                <a href="{{ url_for('makeup.manage_requests', status='pending') }}" 
                   class="btn {% if current_status == 'pending' %}btn-warning{% else %}btn-outline-warning{% endif %}">
                    <i class="fas fa-clock me-1"></i>待审批
                </a>
                <a href="{{ url_for('makeup.manage_requests', status='approved') }}" 
                   class="btn {% if current_status == 'approved' %}btn-success{% else %}btn-outline-success{% endif %}">
                    <i class="fas fa-check me-1"></i>已通过
                </a>
                <a href="{{ url_for('makeup.manage_requests', status='rejected') }}" 
                   class="btn {% if current_status == 'rejected' %}btn-danger{% else %}btn-outline-danger{% endif %}">
                    <i class="fas fa-times me-1"></i>已拒绝
                </a>
            </div>
        </div>
    </div>

    <!-- 申请列表 -->
    {% if requests %}
    <div class="card">
        <div class="card-header bg-gradient">
            <h5 class="mb-0">
                <i class="fas fa-list-ul me-2"></i>
                申请列表（共 {{ requests|length }} 条）
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped mb-0">
                    <thead>
                        <tr>
                            <th width="3%">
                                {% if current_status == 'pending' %}
                                <input type="checkbox" id="selectAll" class="form-check-input">
                                {% endif %}
                            </th>
                            <th width="10%">学生</th>
                            <th width="{% if current_status == 'pending' %}20{% else %}18{% endif %}%">作业名称</th>
                            <th width="10%">班级</th>
                            <th width="20%">补交理由</th>
                            <th width="10%">申请时间</th>
                            <th width="8%">状态</th>
                            {% if current_status != 'pending' %}
                            <th width="8%">处理人</th>
                            {% endif %}
                            <th width="{% if current_status == 'pending' %}16{% else %}13{% endif %}%">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for req in requests %}
                        <tr>
                            <td>
                                {% if req.status == 'pending' and current_status == 'pending' %}
                                <input type="checkbox" class="form-check-input request-checkbox" 
                                       value="{{ req.id }}">
                                {% endif %}
                            </td>
                            <td>
                                <strong>{{ req.student.real_name }}</strong>
                                <br>
                                <small class="text-muted">{{ req.student.username }}</small>
                            </td>
                            <td>
                                <strong>{{ req.assignment.title }}</strong>
                            </td>
                            <td>
                                {% if req.assignment.class_info %}
                                    <span class="badge bg-primary">{{ req.assignment.class_info.name }}</span>
                                {% else %}
                                    <span class="badge bg-secondary">公共作业</span>
                                {% endif %}
                            </td>
                            <td>
                                <small title="{{ req.reason }}">
                                    {{ req.reason[:60] }}{% if req.reason|length > 60 %}...{% endif %}
                                </small>
                            </td>
                            <td>
                                <small>{{ req.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                            </td>
                            <td>
                                {% if req.status == 'pending' %}
                                    <span class="badge bg-warning">
                                        <i class="fas fa-clock me-1"></i>待审批
                                    </span>
                                {% elif req.status == 'approved' %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>已通过
                                    </span>
                                {% elif req.status == 'rejected' %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-times me-1"></i>已拒绝
                                    </span>
                                {% endif %}
                            </td>
                            {% if current_status != 'pending' %}
                            <td>
                                {% if req.processor %}
                                    <strong>{{ req.processor.real_name }}</strong>
                                    <br>
                                    <small class="text-muted">{{ req.processor.username }}</small>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            {% endif %}
                            <td>
                                {% if req.status == 'pending' %}
                                    <button class="btn btn-sm btn-success approve-btn" 
                                            data-request-id="{{ req.id }}"
                                            data-student-name="{{ req.student.real_name }}"
                                            data-assignment-title="{{ req.assignment.title }}">
                                        <i class="fas fa-check me-1"></i>批准
                                    </button>
                                    <button class="btn btn-sm btn-danger reject-btn" 
                                            data-request-id="{{ req.id }}"
                                            data-student-name="{{ req.student.real_name }}"
                                            data-assignment-title="{{ req.assignment.title }}">
                                        <i class="fas fa-times me-1"></i>拒绝
                                    </button>
                                {% elif req.status == 'approved' %}
                                    <div class="d-flex flex-column gap-1">
                                        <small class="text-success">
                                            截止：{{ req.deadline|beijing_time if req.deadline else '未设置' }}
                                        </small>
                                        <button class="btn btn-sm btn-warning modify-deadline-btn" 
                                                data-request-id="{{ req.id }}"
                                                data-student-name="{{ req.student.real_name }}"
                                                data-assignment-title="{{ req.assignment.title }}"
                                                data-current-deadline="{{ req.deadline|beijing_datetime_local }}">
                                            <i class="fas fa-edit me-1"></i>修改截止时间
                                        </button>
                                    </div>
                                {% elif req.status == 'rejected' %}
                                    <small class="text-danger" title="{{ req.reject_reason if req.reject_reason else '无' }}">
                                        {% if req.reject_reason %}
                                            {{ req.reject_reason[:30] }}{% if req.reject_reason|length > 30 %}...{% endif %}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </small>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card">
        <div class="card-body text-center py-5">
            <div class="shortcut-icon-wrapper mb-3 d-inline-block">
                <div class="shortcut-icon secondary-icon">
                    <i class="fas fa-inbox"></i>
                </div>
                <div class="shortcut-glow secondary-glow"></div>
            </div>
            <h5 class="text-muted">暂无补交申请</h5>
            <p class="text-muted">当前筛选条件下没有找到任何补交申请</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- 批准申请模态框 -->
<div class="modal fade" id="approveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>
                    批准补交申请
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3" id="approveInfo"></p>
                <div class="mb-3">
                    <label for="deadline" class="form-label">
                        <i class="fas fa-calendar-alt me-1"></i>
                        补交截止时间 <span class="text-danger">*</span>
                    </label>
                    <input type="datetime-local" class="form-control" id="deadline" required>
                </div>
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    学生需要在设置的截止时间前提交补交作业
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" id="confirmApprove">
                    <i class="fas fa-check me-1"></i>
                    确认批准
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 拒绝申请模态框 -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-times-circle me-2"></i>
                    拒绝补交申请
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3" id="rejectInfo"></p>
                <div class="mb-3">
                    <label for="rejectReason" class="form-label">
                        <i class="fas fa-comment me-1"></i>
                        拒绝理由（可选）
                    </label>
                    <textarea class="form-control" id="rejectReason" rows="3" 
                              placeholder="请填写拒绝理由..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmReject">
                    <i class="fas fa-times me-1"></i>
                    确认拒绝
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 批量批准模态框 -->
<div class="modal fade" id="batchApproveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-double me-2"></i>
                    批量批准申请
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">您已选择 <strong id="batchCount">0</strong> 个待审批的申请</p>
                <div class="mb-3">
                    <label for="batchDeadline" class="form-label">
                        <i class="fas fa-calendar-alt me-1"></i>
                        统一补交截止时间 <span class="text-danger">*</span>
                    </label>
                    <input type="datetime-local" class="form-control" id="batchDeadline" required>
                </div>
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    批量操作将对所有选中的申请设置相同的截止时间
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" id="confirmBatchApprove">
                    <i class="fas fa-check-double me-1"></i>
                    批量批准
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 修改截止时间模态框 -->
<div class="modal fade" id="modifyDeadlineModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>
                    修改补交截止时间
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3" id="modifyDeadlineInfo"></p>
                <div class="mb-3">
                    <label for="newDeadline" class="form-label">
                        <i class="fas fa-calendar-alt me-1"></i>
                        新的截止时间 <span class="text-danger">*</span>
                    </label>
                    <input type="datetime-local" class="form-control" id="newDeadline" required>
                </div>
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    修改后，学生需要在新的截止时间前提交补交作业
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-warning" id="confirmModifyDeadline">
                    <i class="fas fa-check me-1"></i>
                    确认修改
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentRequestId = null;
    const approveModal = new bootstrap.Modal(document.getElementById('approveModal'));
    const rejectModal = new bootstrap.Modal(document.getElementById('rejectModal'));
    const batchApproveModal = new bootstrap.Modal(document.getElementById('batchApproveModal'));
    const modifyDeadlineModal = new bootstrap.Modal(document.getElementById('modifyDeadlineModal'));
    
    // 单个批准
    document.querySelectorAll('.approve-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentRequestId = this.dataset.requestId;
            const studentName = this.dataset.studentName;
            const assignmentTitle = this.dataset.assignmentTitle;
            
            document.getElementById('approveInfo').textContent = 
                `批准学生 ${studentName} 的作业「${assignmentTitle}」补交申请`;
            
            approveModal.show();
        });
    });
    
    // 修改截止时间
    document.querySelectorAll('.modify-deadline-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentRequestId = this.dataset.requestId;
            const studentName = this.dataset.studentName;
            const assignmentTitle = this.dataset.assignmentTitle;
            const currentDeadline = this.dataset.currentDeadline;
            
            document.getElementById('modifyDeadlineInfo').textContent = 
                `修改学生 ${studentName} 的作业「${assignmentTitle}」补交截止时间`;
            
            // 设置当前截止时间为默认值
            document.getElementById('newDeadline').value = currentDeadline;
            
            modifyDeadlineModal.show();
        });
    });
    
    document.getElementById('confirmModifyDeadline').addEventListener('click', function() {
        const newDeadline = document.getElementById('newDeadline').value;
        
        if (!newDeadline) {
            alert('请设置新的截止时间');
            return;
        }
        
        const formData = new FormData();
        formData.append('deadline', newDeadline);
        
        fetch(`/makeup/modify_deadline/${currentRequestId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('操作失败：' + data.message);
            }
        })
        .catch(error => {
            alert('操作失败，请重试');
            console.error(error);
        });
    });
    
    document.getElementById('confirmApprove').addEventListener('click', function() {
        const deadline = document.getElementById('deadline').value;
        
        if (!deadline) {
            alert('请设置补交截止时间');
            return;
        }
        
        const formData = new FormData();
        formData.append('deadline', deadline);
        
        fetch(`/makeup/approve/${currentRequestId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('操作失败：' + data.message);
            }
        })
        .catch(error => {
            alert('操作失败，请重试');
            console.error(error);
        });
    });
    
    // 单个拒绝
    document.querySelectorAll('.reject-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentRequestId = this.dataset.requestId;
            const studentName = this.dataset.studentName;
            const assignmentTitle = this.dataset.assignmentTitle;
            
            document.getElementById('rejectInfo').textContent = 
                `拒绝学生 ${studentName} 的作业「${assignmentTitle}」补交申请`;
            
            rejectModal.show();
        });
    });
    
    document.getElementById('confirmReject').addEventListener('click', function() {
        const rejectReason = document.getElementById('rejectReason').value;
        
        const formData = new FormData();
        formData.append('reject_reason', rejectReason);
        
        fetch(`/makeup/reject/${currentRequestId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('操作失败：' + data.message);
            }
        })
        .catch(error => {
            alert('操作失败，请重试');
            console.error(error);
        });
    });
    
    // 复选框管理
    const selectAllCheckbox = document.getElementById('selectAll');
    const requestCheckboxes = document.querySelectorAll('.request-checkbox');
    const batchApproveBtn = document.getElementById('batchApproveBtn');
    
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            requestCheckboxes.forEach(cb => {
                cb.checked = this.checked;
            });
            updateBatchButton();
        });
    }
    
    requestCheckboxes.forEach(cb => {
        cb.addEventListener('change', updateBatchButton);
    });
    
    function updateBatchButton() {
        const checkedCount = document.querySelectorAll('.request-checkbox:checked').length;
        batchApproveBtn.disabled = checkedCount === 0;
        
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = checkedCount === requestCheckboxes.length && checkedCount > 0;
        }
    }
    
    // 批量批准
    if (batchApproveBtn) {
        batchApproveBtn.addEventListener('click', function() {
            const checkedCount = document.querySelectorAll('.request-checkbox:checked').length;
            document.getElementById('batchCount').textContent = checkedCount;
            batchApproveModal.show();
        });
    }
    
    document.getElementById('confirmBatchApprove').addEventListener('click', function() {
        const deadline = document.getElementById('batchDeadline').value;
        
        if (!deadline) {
            alert('请设置补交截止时间');
            return;
        }
        
        const selectedIds = Array.from(document.querySelectorAll('.request-checkbox:checked'))
            .map(cb => cb.value);
        
        const formData = new FormData();
        selectedIds.forEach(id => formData.append('request_ids[]', id));
        formData.append('deadline', deadline);
        
        fetch('/makeup/batch_approve', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('操作失败：' + data.message);
            }
        })
        .catch(error => {
            alert('操作失败，请重试');
            console.error(error);
        });
    });
});
</script>

{% endblock %}
