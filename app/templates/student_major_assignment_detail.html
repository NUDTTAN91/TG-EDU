{% extends "base.html" %}

{% block title %}{{ major_assignment.title }} - 我的团队{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <!-- 作业信息 -->
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-project-diagram me-2"></i>
                        {{ major_assignment.title }}
                    </h4>
                </div>
                <div class="card-body">
                    {% if major_assignment.description %}
                    <p class="mb-3">{{ major_assignment.description }}</p>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-2">
                                <i class="fas fa-users me-2"></i>
                                <strong>组队人数：</strong>{{ major_assignment.min_team_size }} - {{ major_assignment.max_team_size }} 人
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2">
                                <i class="fas fa-calendar-alt me-2"></i>
                                <strong>截止时间：</strong>
                                {{ major_assignment.due_date|beijing_time if major_assignment.due_date else '无' }}
                            </p>
                        </div>
                    </div>
                    
                    {% if major_assignment.requirement_file_path %}
                    <a href="{{ url_for('major_assignment.download_major_assignment_requirement', assignment_id=major_assignment.id) }}" 
                       class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-download me-1"></i>下载作业要求文件
                    </a>
                    {% elif major_assignment.requirement_url %}
                    <a href="{{ major_assignment.requirement_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-external-link-alt me-1"></i>查看作业要求
                    </a>
                    {% endif %}
                </div>
            </div>

            {% if my_team %}
            <!-- 我的团队 -->
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>
                        我的团队：{{ my_team.name }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>团队信息</h6>
                            <p>
                                <i class="fas fa-crown text-warning me-2"></i>
                                <strong>组长：</strong>{{ my_team.leader.real_name }}
                            </p>
                            <p>
                                <strong>人数：</strong>{{ my_team.get_member_count() }} 人
                            </p>
                            <p>
                                <strong>状态：</strong>
                                {% if my_team.status == 'confirmed' %}
                                <span class="badge bg-success">已确认</span>
                                {% elif my_team.status == 'rejected' %}
                                <span class="badge bg-danger">已拒绝</span>
                                {% else %}
                                <span class="badge bg-warning">待确认</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6>团队成员</h6>
                            <ul class="list-unstyled">
                                <li class="mb-1">
                                    <i class="fas fa-crown text-warning me-2"></i>
                                    {{ my_team.leader.real_name }} ({{ my_team.leader.student_id }})
                                </li>
                                {% for member in my_team.members %}
                                <li class="mb-1">
                                    <i class="fas fa-user me-2"></i>
                                    {{ member.user.real_name }} ({{ member.user.student_id }})
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <!-- 组长操作 -->
                    {% if my_team.leader_id == current_user.id %}
                    <hr>
                    <div class="mb-3">
                        <h6>组长操作</h6>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inviteModal">
                            <i class="fas fa-user-plus me-1"></i>邀请成员
                        </button>
                        <button class="btn btn-danger ms-2" data-bs-toggle="modal" data-bs-target="#dissolveModal">
                            <i class="fas fa-trash-alt me-1"></i>解散团队
                        </button>
                        <button class="btn btn-info ms-2" data-bs-toggle="modal" data-bs-target="#invitationRecordsModal">
                            <i class="fas fa-history me-1"></i>邀请记录
                            {% if team_invitations|length > 0 %}
                            <span class="badge bg-light text-dark">{{ team_invitations|length }}</span>
                            {% endif %}
                        </button>
                    </div>
                    {% else %}
                    <!-- 组员操作 -->
                    <hr>
                    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#leaveModal">
                        <i class="fas fa-sign-out-alt me-1"></i>申请退组
                    </button>
                    {% endif %}
                </div>
            </div>
            
            {% else %}
            <!-- 创建或加入团队 -->
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>
                        组队
                    </h5>
                </div>
                <div class="card-body text-center">
                    <i class="fas fa-users fa-4x text-muted mb-3"></i>
                    <p class="text-muted mb-4">您还没有加入任何团队</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTeamModal">
                        <i class="fas fa-plus me-1"></i>创建团队
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 创建团队模态框 -->
<div class="modal fade" id="createTeamModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">创建团队</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('major_assignment.create_team', assignment_id=major_assignment.id) }}" method="POST">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        团队名称将自动生成为：<strong>您的姓名 + 的团队</strong>
                    </div>
                    <p class="text-muted">点击"创建"按钮后，您将成为团队组长</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">创建</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 邀请成员模态框 -->
{% if my_team and my_team.leader_id == current_user.id %}
<div class="modal fade" id="inviteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">邀请成员</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('major_assignment.invite_team_members', team_id=my_team.id) }}" method="POST">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        请准确填写同学的姓名和学号进行邀请
                    </div>
                    <div class="mb-3">
                        <label for="invitee_name" class="form-label">
                            <i class="fas fa-user me-1"></i>同学姓名 <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="invitee_name" name="invitee_name" 
                               placeholder="请输入同学的真实姓名" required>
                    </div>
                    <div class="mb-3">
                        <label for="invitee_number" class="form-label">
                            <i class="fas fa-id-card me-1"></i>同学学号 <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="invitee_number" name="invitee_number" 
                               placeholder="请输入同学的学号" required>
                        <small class="form-text text-muted">姓名和学号必须同时匹配才能发送邀请</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-1"></i>发送邀请
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- 解散团队模态框 -->
{% if my_team and my_team.leader_id == current_user.id %}
<div class="modal fade" id="dissolveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>解散团队
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('major_assignment.request_dissolve_team', team_id=my_team.id) }}" method="POST">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <strong>注意：</strong>解散团队需要超级管理员或负责老师确认后才会生效。解散后，所有团队成员将被移除。
                    </div>
                    <div class="mb-3">
                        <label class="form-label">解散原因 <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="reason" rows="3" 
                                  placeholder="请说明解散团队的原因..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt me-1"></i>申请解散
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- 退组申请模态框 -->
{% if my_team and my_team.leader_id != current_user.id %}
<div class="modal fade" id="leaveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">申请退组</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('major_assignment.request_leave_team', team_id=my_team.id) }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">退组原因</label>
                        <textarea class="form-control" name="reason" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-warning">提交申请</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- 邀请记录模态框 -->
{% if my_team and my_team.leader_id == current_user.id %}
<div class="modal fade" id="invitationRecordsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-history me-2"></i>邀请记录
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if team_invitations|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>被邀请人</th>
                                <th>学号</th>
                                <th>邀请时间</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invitation in team_invitations %}
                            <tr>
                                <td>
                                    <i class="fas fa-user me-1"></i>
                                    {{ invitation.invitee.real_name }}
                                </td>
                                <td>{{ invitation.invitee.student_id }}</td>
                                <td>
                                    <small class="text-muted">
                                        {{ invitation.created_at|beijing_time }}
                                    </small>
                                </td>
                                <td>
                                    {% if invitation.status == 'pending' %}
                                    <span class="badge bg-warning">
                                        <i class="fas fa-clock me-1"></i>待处理
                                    </span>
                                    {% elif invitation.status == 'accepted' %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check-circle me-1"></i>已接受
                                    </span>
                                    {% elif invitation.status == 'rejected' %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-times-circle me-1"></i>已拒绝
                                    </span>
                                    {% elif invitation.status == 'cancelled' %}
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-ban me-1"></i>已取消
                                    </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if invitation.status == 'rejected' %}
                                    <!-- 检查被邀请人是否已加入其他团队 -->
                                    {% set invitee_in_other_team = false %}
                                    {% for team in major_assignment.teams %}
                                        {% if team.leader_id == invitation.invitee.id %}
                                            {% set invitee_in_other_team = true %}
                                        {% endif %}
                                        {% for member in team.members %}
                                            {% if member.user_id == invitation.invitee.id %}
                                                {% set invitee_in_other_team = true %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                    
                                    {% if invitee_in_other_team %}
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-user-check me-1"></i>已加入其他组
                                    </span>
                                    {% else %}
                                    <form action="{{ url_for('major_assignment.resend_team_invitation', invitation_id=invitation.id) }}" 
                                          method="POST" style="display: inline;">
                                        <button type="submit" class="btn btn-sm btn-primary" 
                                                onclick="return confirm('确定要重新发送邀请给 {{ invitation.invitee.real_name }} 吗？');">
                                            <i class="fas fa-redo me-1"></i>重新邀请
                                        </button>
                                    </form>
                                    {% endif %}
                                    {% elif invitation.status == 'accepted' %}
                                    <span class="text-muted small">
                                        <i class="fas fa-check me-1"></i>已加入团队
                                    </span>
                                    {% elif invitation.status == 'pending' %}
                                    <span class="text-muted small">
                                        <i class="fas fa-hourglass-half me-1"></i>等待回应
                                    </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">暂无邀请记录</p>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
