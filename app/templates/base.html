<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ä½œä¸šæ”¶é›†ç³»ç»Ÿ{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="{{ url_for('static', filename='css/vendor/bootstrap.min.css') }}" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="{{ url_for('static', filename='css/vendor/font-awesome.min.css') }}" rel="stylesheet">
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    
    <!-- é¡µé¢å›¾æ ‡ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“š</text></svg>">
</head>
<body>
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid">
            <!-- ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’® -->
            {% if current_user.is_authenticated and request.endpoint != 'index' %}
            <button class="btn btn-outline-light d-lg-none me-2" type="button" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            {% endif %}
            
            <a class="navbar-brand" href="{{ url_for('main.index') }}">
                <i class="fas fa-graduation-cap me-2"></i>
                TG-EDUç»¼åˆæ•™è‚²å¹³å°
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto d-flex align-items-center">
                    {% if current_user.is_authenticated %}
                        <!-- é€šçŸ¥é“ƒé“›å›¾æ ‡ -->
                        <div class="nav-item dropdown me-3">
                            <a class="nav-link position-relative" href="#" id="notificationDropdown" 
                               role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-bell fs-5"></i>
                                {% if unread_notification_count > 0 %}
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                    {{ unread_notification_count }}
                                    <span class="visually-hidden">æœªè¯»é€šçŸ¥</span>
                                </span>
                                {% endif %}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end notification-dropdown" 
                                aria-labelledby="notificationDropdown" style="min-width: 320px; max-height: 400px; overflow-y: auto;">
                                <li class="dropdown-header d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-bell me-2"></i>é€šçŸ¥ä¸­å¿ƒ</span>
                                    {% if unread_notification_count > 0 %}
                                    <span class="badge bg-danger">{{ unread_notification_count }}</span>
                                    {% endif %}
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                
                                <!-- æ˜¾ç¤ºæœ€è¿‘3æ¡æœªè¯»é€šçŸ¥ -->
                                {% if current_user.is_authenticated %}
                                    {% set all_unread = current_user.received_notifications|selectattr('is_read', 'equalto', False)|list|sort(attribute='created_at', reverse=True) %}
                                    {% if all_unread %}
                                        {% for notification in all_unread[:3] %}
                                        <li>
                                            <a class="dropdown-item notification-item" href="{{ url_for('notification.notifications') }}">
                                                <div class="d-flex">
                                                    <div class="flex-shrink-0">
                                                        {% if notification.notification_type == 'grade' %}
                                                        <i class="fas fa-star text-warning"></i>
                                                        {% elif notification.notification_type == 'assignment' %}
                                                        <i class="fas fa-tasks text-info"></i>
                                                        {% else %}
                                                        <i class="fas fa-info-circle text-primary"></i>
                                                        {% endif %}
                                                    </div>
                                                    <div class="flex-grow-1 ms-2">
                                                        <h6 class="mb-1 small">{{ notification.title }}</h6>
                                                        <p class="mb-1 text-muted small" style="font-size: 0.85rem;">
                                                            {{ notification.content[:50] }}{% if notification.content|length > 50 %}...{% endif %}
                                                        </p>
                                                        <small class="text-muted" style="font-size: 0.75rem;">
                                                            {{ notification.created_at|beijing_short }}
                                                        </small>
                                                    </div>
                                                </div>
                                            </a>
                                        </li>
                                        {% endfor %}
                                    {% else %}
                                        <li class="dropdown-item text-center text-muted">
                                            <i class="fas fa-inbox"></i> æš‚æ— æœªè¯»é€šçŸ¥
                                        </li>
                                    {% endif %}
                                {% endif %}
                                
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-center text-primary" href="{{ url_for('notification.notifications') }}">
                                        <i class="fas fa-list me-1"></i>æŸ¥çœ‹æ‰€æœ‰é€šçŸ¥
                                    </a>
                                </li>
                            </ul>
                        </div>
                        
                        <!-- æ˜¾ç¤ºå½“å‰ç”¨æˆ·ä¿¡æ¯ -->
                        <span class="nav-text text-light mx-2">
                            <i class="fas fa-user me-1"></i>{{ current_user.real_name }}
                        </span>
                        
                        <a class="nav-link" href="{{ url_for('auth.logout') }}">
                            <i class="fas fa-sign-out-alt me-1"></i>é€€å‡º
                        </a>
                    {% else %}
                        <a class="nav-link" href="{{ url_for('auth.login') }}">
                            <i class="fas fa-user me-1"></i>ç”¨æˆ·ç™»å½•
                        </a>
                    {% endif %}

                </div>
            </div>
        </div>
    </nav>

    {% if current_user.is_authenticated and request.endpoint != 'index' %}
    <!-- å…¨å±€å·¦ä¾§èœå•æ ï¼ˆé¦–é¡µé™¤å¤–ï¼‰ -->
    <div class="global-sidebar" id="globalSidebar">
        <div class="sidebar-header">
            <div class="user-info">
                <div class="user-avatar">
                    {% if current_user.is_super_admin %}
                        <i class="fas fa-crown"></i>
                    {% elif current_user.is_teacher %}
                        <i class="fas fa-chalkboard-teacher"></i>
                    {% else %}
                        <i class="fas fa-user-graduate"></i>
                    {% endif %}
                </div>
                <div class="user-details">
                    <h6 class="user-name">{{ current_user.real_name }}</h6>
                    <p class="user-role">
                        {% if current_user.is_super_admin %}
                            è¶…çº§ç®¡ç†å‘˜
                        {% elif current_user.is_teacher %}
                            æ•™å¸ˆ
                        {% else %}
                            å­¦ç”Ÿ
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        
        <div class="sidebar-content">
            <!-- ä¸»é¡µå¿«æ·æ–¹å¼ -->
            <div class="sidebar-section">
                <h6 class="section-title">
                    <i class="fas fa-home me-2"></i>
                    ä¸»é¡µå¯¼èˆª
                </h6>
                <div class="menu-list">
                    <a href="{{ url_for('main.index') }}" class="menu-item">
                        <div class="menu-icon">
                            <i class="fas fa-home"></i>
                        </div>
                        <span class="menu-title">ç³»ç»Ÿé¦–é¡µ</span>
                    </a>
                    
                    {% if current_user.is_super_admin %}
                        <a href="{{ url_for('admin.super_admin_dashboard') }}" class="menu-item">
                            <div class="menu-icon">
                                <i class="fas fa-tachometer-alt"></i>
                            </div>
                            <span class="menu-title">è¶…çº§ç®¡ç†å‘˜</span>
                        </a>
                    {% elif current_user.is_teacher %}
                        <a href="{{ url_for('admin.teacher_dashboard') }}" class="menu-item">
                            <div class="menu-icon">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <span class="menu-title">æ•™å¸ˆåå°</span>
                        </a>
                    {% else %}
                        <a href="{{ url_for('student.dashboard') }}" class="menu-item">
                            <div class="menu-icon">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <span class="menu-title">å­¦ç”Ÿä¸­å¿ƒ</span>
                        </a>
                    {% endif %}
                </div>
            </div>
            
            <!-- å¿«æ·æ“ä½œ -->
            {% if current_user.is_super_admin or current_user.is_teacher %}
            <div class="sidebar-section">
                <h6 class="section-title">
                    <i class="fas fa-rocket me-2"></i>
                    å¿«æ·æ“ä½œ
                </h6>
                <div class="menu-list">
                    {% if current_user.is_super_admin %}
                        <!-- 1. ç”¨æˆ·ç®¡ç† -->
                        <a href="{{ url_for('user_mgmt.manage_users') }}" class="menu-item primary">
                            <div class="menu-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <span class="menu-title">ç”¨æˆ·ç®¡ç†</span>
                        </a>
                        
                        <!-- 2. ç­çº§ç®¡ç† -->
                        <a href="{{ url_for('class_mgmt.manage_classes') }}" class="menu-item warning">
                            <div class="menu-icon">
                                <i class="fas fa-school"></i>
                            </div>
                            <span class="menu-title">ç­çº§ç®¡ç†</span>
                        </a>
                        
                        <!-- 3. åˆ›å»ºä½œä¸š -->
                        <a href="{{ url_for('assignment.create_assignment') }}" class="menu-item success">
                            <div class="menu-icon">
                                <i class="fas fa-plus-circle"></i>
                            </div>
                            <span class="menu-title">åˆ›å»ºä½œä¸š</span>
                        </a>
                        
                        <!-- 4. ä½œä¸šç®¡ç† -->
                        <a href="{{ url_for('admin.super_admin_dashboard') }}" class="menu-item info">
                            <div class="menu-icon">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <span class="menu-title">ä½œä¸šç®¡ç†</span>
                        </a>
                        
                        <!-- 5. å¤§ä½œä¸šç®¡ç† -->
                        <a href="{{ url_for('major_assignment.major_assignment_dashboard') }}" class="menu-item purple">
                            <div class="menu-icon">
                                <i class="fas fa-project-diagram"></i>
                            </div>
                            <span class="menu-title">å¤§ä½œä¸šç®¡ç†</span>
                        </a>
                        
                        <!-- 6. è¡¥äº¤ç®¡ç† -->
                        <a href="{{ url_for('makeup.manage_requests') }}" class="menu-item warning">
                            <div class="menu-icon">
                                <i class="fas fa-file-upload"></i>
                            </div>
                            <span class="menu-title">è¡¥äº¤ç®¡ç†</span>
                        </a>
                        
                        <!-- 7. ç³»ç»Ÿæ—¥å¿— -->
                        <a href="{{ url_for('logs.index') }}" class="menu-item info">
                            <div class="menu-icon">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                            <span class="menu-title">ç³»ç»Ÿæ—¥å¿—</span>
                        </a>
                        
                        <div class="menu-item secondary" onclick="showBatchImport()">
                            <div class="menu-icon">
                                <i class="fas fa-file-excel"></i>
                            </div>
                            <span class="menu-title">æ‰¹é‡å¯¼å…¥</span>
                        </div>
                        
                        <!-- 8. ç³»ç»Ÿé‡ç½® -->
                        <div class="menu-item danger" onclick="showSystemReset()">
                            <div class="menu-icon">
                                <i class="fas fa-undo"></i>
                            </div>
                            <span class="menu-title">ç³»ç»Ÿé‡ç½®</span>
                        </div>
                    {% endif %}
                    
                    {% if current_user.is_teacher %}
                        <a href="{{ url_for('assignment.create_assignment') }}" class="menu-item success">
                            <div class="menu-icon">
                                <i class="fas fa-plus-circle"></i>
                            </div>
                            <span class="menu-title">åˆ›å»ºä½œä¸š</span>
                        </a>
                        
                        <a href="{{ url_for('admin.teacher_dashboard') }}" class="menu-item info">
                            <div class="menu-icon">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <span class="menu-title">ä½œä¸šç®¡ç†</span>
                        </a>
                        
                        <!-- å¤§ä½œä¸šç®¡ç† -->
                        <a href="{{ url_for('major_assignment.major_assignment_dashboard') }}" class="menu-item purple">
                            <div class="menu-icon">
                                <i class="fas fa-project-diagram"></i>
                            </div>
                            <span class="menu-title">å¤§ä½œä¸šç®¡ç†</span>
                        </a>
                        
                        <!-- è¡¥äº¤ç®¡ç† -->
                        <a href="{{ url_for('makeup.manage_requests') }}" class="menu-item warning">
                            <div class="menu-icon">
                                <i class="fas fa-file-upload"></i>
                            </div>
                            <span class="menu-title">è¡¥äº¤ç®¡ç†</span>
                        </a>
                        
                        <a href="{{ url_for('user_mgmt.manage_users') }}" class="menu-item info">
                            <div class="menu-icon">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <span class="menu-title">å­¦ç”Ÿç®¡ç†</span>
                        </a>
                        
                        <a href="{{ url_for('class_mgmt.manage_classes') }}" class="menu-item warning">
                            <div class="menu-icon">
                                <i class="fas fa-school"></i>
                            </div>
                            <span class="menu-title">ç­çº§ç®¡ç†</span>
                        </a>
                        
                        <div class="menu-item secondary" onclick="showBatchImport()">
                            <div class="menu-icon">
                                <i class="fas fa-file-excel"></i>
                            </div>
                            <span class="menu-title">æ‰¹é‡å¯¼å…¥</span>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- å­¦ç”Ÿå¿«æ·æ“ä½œ -->
            {% if not current_user.is_teacher and not current_user.is_super_admin %}
            <div class="sidebar-section">
                <h6 class="section-title">
                    <i class="fas fa-rocket me-2"></i>
                    å­¦ç”ŸåŠŸèƒ½
                </h6>
                <div class="menu-list">
                    <a href="{{ url_for('student.dashboard') }}" class="menu-item primary">
                        <div class="menu-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <span class="menu-title">æˆ‘çš„ä½œä¸š</span>
                    </a>
                    
                    <a href="{{ url_for('makeup.my_requests') }}" class="menu-item warning">
                        <div class="menu-icon">
                            <i class="fas fa-file-upload"></i>
                        </div>
                        <span class="menu-title">è¡¥äº¤ç”³è¯·</span>
                    </a>
                </div>
            </div>
            {% endif %}
            
            <!-- é€šçŸ¥ä¸­å¿ƒ -->
            <div class="sidebar-section">
                <h6 class="section-title">
                    <i class="fas fa-bell me-2"></i>
                    é€šçŸ¥ä¸­å¿ƒ
                </h6>
                <div class="menu-list">
                    <a href="{{ url_for('notification.notifications') }}" class="menu-item info">
                        <div class="menu-icon">
                            <i class="fas fa-bell"></i>
                        </div>
                        <span class="menu-title">
                            æˆ‘çš„é€šçŸ¥
                            {% if unread_notification_count > 0 %}
                            <span class="badge bg-danger ms-2">{{ unread_notification_count }}</span>
                            {% endif %}
                        </span>
                    </a>
                    
                    {% if current_user.is_teacher or current_user.is_super_admin %}
                    <a href="{{ url_for('notification.create_notification_page') }}" class="menu-item success">
                        <div class="menu-icon">
                            <i class="fas fa-paper-plane"></i>
                        </div>
                        <span class="menu-title">å‘é€é€šçŸ¥</span>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- æ‰¹é‡å¯¼å…¥æ¨¡æ€æ¡† -->
    <div class="modal fade" id="batchImportModal" tabindex="-1" aria-labelledby="batchImportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="batchImportModalLabel">
                        <i class="fas fa-file-excel me-2"></i>
                        æ‰¹é‡å¯¼å…¥ç”¨æˆ·
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="background-color: #ffffff; color: #212529;">
                    <form id="batchImportForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="csvFile" class="form-label" style="color: #212529; font-weight: 600;">
                                <i class="fas fa-file-csv me-2" style="color: #0d6efd;"></i>
                                é€‰æ‹©CSV/TSVæ–‡ä»¶
                            </label>
                            <input type="file" class="form-control" id="csvFile" name="file" accept=".csv,.tsv,.txt" required>
                        </div>
                        <div class="mb-3">
                            <a href="{{ url_for('static', filename='sample_users.csv') }}" class="btn btn-outline-primary btn-sm" download>
                                <i class="fas fa-download me-1"></i>
                                ä¸‹è½½ç¤ºä¾‹æ–‡ä»¶
                            </a>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="background-color: #f8f9fa; border-top: 1px solid #dee2e6;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>
                        å–æ¶ˆ
                    </button>
                    <button type="button" class="btn btn-primary" onclick="importUsers()">
                        <i class="fas fa-upload me-2"></i>
                        å¼€å§‹å¯¼å…¥
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="{% if current_user.is_authenticated and request.endpoint != 'index' %}main-wrapper{% else %}container{% endif %}" style="{% if not current_user.is_authenticated or request.endpoint == 'index' %}margin-top: 100px; {% endif %}min-height: calc(100vh - 200px);">
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <!-- é¡µè„š -->
    <footer class="footer mt-5">
        <div class="container">
            <div class="text-center author-section">
                <div class="author-badge mb-3">
                    <div class="author-avatar">
                        <img src="{{ url_for('static', filename='images/avatar.svg') }}" alt="ä½œè€…å¤´åƒ" class="avatar-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <i class="fas fa-user-graduate avatar-fallback"></i>
                    </div>
                    <div class="author-info ms-3">
                        <h5 class="author-name mb-1">
                            <i class="fas fa-crown me-2"></i>
                            ä½œè€…: <strong>tan91</strong>
                        </h5>
                        <div class="author-links">
                            <a href="https://github.com/NUDTTAN91" target="_blank" class="author-link github-link">
                                <i class="fab fa-github me-1"></i>
                                GitHub
                            </a>
                            <span class="link-separator">|</span>
                            <a href="https://blog.csdn.net/ZXW_NUDT" target="_blank" class="author-link blog-link">
                                <i class="fas fa-blog me-1"></i>
                                CSDNåšå®¢
                            </a>
                        </div>
                    </div>
                </div>
                <div class="author-quote">
                    <i class="fas fa-quote-left quote-icon"></i>
                    <p class="quote-text">TG-EDUç»¼åˆæ•™è‚²å¹³å° - è®©æ•™å­¦æ›´è½»æ¾ï¼Œè®©å­¦ä¹ æ›´é«˜æ•ˆ</p>
                    <i class="fas fa-quote-right quote-icon"></i>
                </div>
                <div class="copyright-info">
                    <p class="mb-0">
                        <i class="fas fa-copyright me-1"></i>
                        2025 tan91 ç‰ˆæƒæ‰€æœ‰
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="{{ url_for('static', filename='js/vendor/bootstrap.bundle.min.js') }}"></script>
    <!-- é¡µé¢åŠ¨ç”»å’Œäº¤äº’æ•ˆæœ -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    <!-- å…¨å±€ä¾§è¾¹æ æ§åˆ¶JS -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const sidebarToggle = document.getElementById('sidebarToggle');
        const globalSidebar = document.getElementById('globalSidebar');
        const mainWrapper = document.querySelector('.main-wrapper');
        
        if (sidebarToggle && globalSidebar) {
            sidebarToggle.addEventListener('click', function() {
                globalSidebar.classList.toggle('active');
                if (mainWrapper) {
                    mainWrapper.classList.toggle('expanded');
                }
            });
            
            // ç‚¹å‡»ä¸»å†…å®¹åŒºåŸŸæ—¶éšè—ä¾§è¾¹æ ï¼ˆç§»åŠ¨ç«¯ï¼‰
            if (window.innerWidth <= 992 && mainWrapper) {
                mainWrapper.addEventListener('click', function() {
                    globalSidebar.classList.remove('active');
                    mainWrapper.classList.remove('expanded');
                });
            }
            
            // çª—å£å¤§å°æ”¹å˜æ—¶çš„å¤„ç†
            window.addEventListener('resize', function() {
                if (window.innerWidth > 992) {
                    globalSidebar.classList.remove('active');
                    if (mainWrapper) {
                        mainWrapper.classList.remove('expanded');
                    }
                }
            });
        }
        
        // èœå•é¡¹ç›®åŠ¨ç”»
        const menuItems = document.querySelectorAll('.menu-item');
        menuItems.forEach((item, index) => {
            item.style.opacity = '0';
            item.style.transform = 'translateX(-20px)';
            setTimeout(() => {
                item.style.transition = 'all 0.3s ease';
                item.style.opacity = '1';
                item.style.transform = 'translateX(0)';
            }, index * 100);
        });
    });
    
    // å¿«æ·æ“ä½œå‡½æ•°
    function showBatchImport() {
        const modal = new bootstrap.Modal(document.getElementById('batchImportModal'));
        modal.show();
    }
    
    function showDownloadOptions() {
        alert('ä¸‹è½½ä½œä¸šåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…...');
    }
    
    function importUsers() {
        const fileInput = document.getElementById('csvFile');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('è¯·é€‰æ‹©ä¸€ä¸ªCSVæ–‡ä»¶');
            return;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const importBtn = document.querySelector('#batchImportModal .btn-primary');
        const originalText = importBtn.textContent;
        importBtn.textContent = 'å¯¼å…¥ä¸­...';
        importBtn.disabled = true;
        
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/admin/users/batch-import', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let message = `å¯¼å…¥å®Œæˆï¼\nâœ… æˆåŠŸå¯¼å…¥: ${data.success_count} ä¸ªç”¨æˆ·`;
                if (data.error_count > 0) {
                    message += `\nâŒ å¤±è´¥: ${data.error_count} ä¸ªç”¨æˆ·`;
                    if (data.errors && data.errors.length > 0) {
                        message += '\n\né”™è¯¯è¯¦æƒ…:';
                        data.errors.slice(0, 5).forEach(error => {
                            message += '\n- ' + error;
                        });
                        if (data.errors.length > 5) {
                            message += `\n... è¿˜æœ‰ ${data.errors.length - 5} ä¸ªé”™è¯¯`;
                        }
                    }
                }
                alert(message);
                
                // å…³é—­æ¨¡æ€æ¡†
                const modal = bootstrap.Modal.getInstance(document.getElementById('batchImportModal'));
                modal.hide();
                
                // å¦‚æœæœ‰æˆåŠŸå¯¼å…¥çš„ç”¨æˆ·ï¼Œåˆ·æ–°é¡µé¢
                if (data.success_count > 0) {
                    location.reload();
                }
            } else {
                alert('âŒ å¯¼å…¥å¤±è´¥: ' + data.message);
            }
        })
        .catch(error => {
            console.error('å¯¼å…¥é”™è¯¯:', error);
            alert('âŒ å¯¼å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
        })
        .finally(() => {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            importBtn.textContent = originalText;
            importBtn.disabled = false;
        });
    }
    
    function showSystemReset() {
        window.location.href = "{{ url_for('advanced.reset_system') }}";
    }
    
    // ========================
    // å…¨å±€æ»šåŠ¨ä½ç½®ä¿æŒåŠŸèƒ½
    // ========================
    
    // ä¿å­˜æ»šåŠ¨ä½ç½®
    function saveScrollPosition() {
        sessionStorage.setItem('scrollPosition', window.scrollY);
    }
    
    // æ¢å¤æ»šåŠ¨ä½ç½®
    function restoreScrollPosition() {
        const savedPosition = sessionStorage.getItem('scrollPosition');
        if (savedPosition !== null) {
            window.scrollTo(0, parseInt(savedPosition));
            // æ¸…é™¤ä¿å­˜çš„ä½ç½®ï¼Œé¿å…å½±å“å…¶ä»–é¡µé¢
            sessionStorage.removeItem('scrollPosition');
        }
    }
    
    // é¡µé¢åŠ è½½æ—¶æ¢å¤æ»šåŠ¨ä½ç½®
    window.addEventListener('DOMContentLoaded', function() {
        restoreScrollPosition();
    });
    
    // ä¸ºæ‰€æœ‰å¸¦æœ‰ href çš„é“¾æ¥æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œä¿å­˜æ»šåŠ¨ä½ç½®
    document.addEventListener('click', function(e) {
        const target = e.target.closest('a[href]');
        if (target && target.href && !target.hasAttribute('target')) {
            // æ’é™¤é™„ä»¶ä¸‹è½½å’Œå¤–éƒ¨é“¾æ¥
            const url = new URL(target.href);
            if (url.hostname === window.location.hostname && 
                !target.href.includes('/download/') && 
                !target.href.includes('/attachment/')) {
                saveScrollPosition();
            }
        }
    });
    
    // ä¸ºè¡¨å•æäº¤æ·»åŠ äº‹ä»¶
    document.addEventListener('submit', function(e) {
        // å¦‚æœæ˜¯GETè¯·æ±‚ï¼Œä¿å­˜æ»šåŠ¨ä½ç½®
        if (e.target.method.toLowerCase() === 'get') {
            saveScrollPosition();
        }
    });
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>