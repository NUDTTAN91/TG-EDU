{% extends "base.html" %}

{% block title %}超级管理员仪表板 - TG作业系统{% endblock %}

{% block content %}
<!-- 超级管理员欢迎页 -->
<div class="hero-section mb-5">
    <div class="text-center">
        <div class="admin-icon mb-3">
            <i class="fas fa-user-shield" style="font-size: 4rem; color: var(--accent-color);"></i>
        </div>
        <h1 class="display-5 fw-bold mb-3 fade-in-up">
            <i class="fas fa-crown me-3"></i>
            超级管理员仪表板
        </h1>
        <p class="lead mb-4 fade-in-up" style="animation-delay: 0.2s;">
            <i class="fas fa-hand-sparkles me-2"></i>
            欢迎回来，{{ current_user.real_name }}！您拥有系统的最高权限
        </p>
    </div>
</div>

<!-- 快速统计 -->
<div class="row mb-5">
    <div class="col-md-3 mb-3">
        <div class="card stat-card text-center">
            <div class="card-body">
                <div class="shortcut-icon-wrapper mb-3">
                    <div class="shortcut-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="shortcut-glow"></div>
                </div>
                <h3 class="stat-number">{{ total_users }}</h3>
                <p class="stat-label mb-0">总用户数</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card text-center">
            <div class="card-body">
                <div class="shortcut-icon-wrapper mb-3">
                    <div class="shortcut-icon warning-icon">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                    <div class="shortcut-glow warning-glow"></div>
                </div>
                <h3 class="stat-number warning-text">{{ total_teachers }}</h3>
                <p class="stat-label mb-0">教师数量</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card text-center">
            <div class="card-body">
                <div class="shortcut-icon-wrapper mb-3">
                    <div class="shortcut-icon success-icon">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div class="shortcut-glow success-glow"></div>
                </div>
                <h3 class="stat-number success-text">{{ total_students }}</h3>
                <p class="stat-label mb-0">学生数量</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card text-center">
            <div class="card-body">
                <div class="shortcut-icon-wrapper mb-3">
                    <div class="shortcut-icon warning-icon">
                        <i class="fas fa-school"></i>
                    </div>
                    <div class="shortcut-glow warning-glow"></div>
                </div>
                <h3 class="stat-number warning-text">{{ total_classes }}</h3>
                <p class="stat-label mb-0">班级数量</p>
            </div>
        </div>
    </div>
</div>

<!-- 主操作区 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="fw-bold">
                <i class="fas fa-cogs me-2" style="color: var(--accent-color);"></i>
                系统管理
            </h2>
        </div>
    </div>
</div>

<!-- 班级管理快速操作 -->
<div class="row mb-5">
    <div class="col-12">
        <h3 class="fw-bold mb-3">
            <i class="fas fa-school me-2" style="color: var(--accent-color);"></i>
            班级管理
        </h3>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card quick-action-card h-100">
            <div class="card-body text-center">
                <div class="shortcut-icon-wrapper mb-3">
                    <div class="shortcut-icon success-icon">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <div class="shortcut-glow success-glow"></div>
                </div>
                <h5 class="card-title">创建班级</h5>
                <p class="card-text text-muted">创建新的班级，分配教师和学生</p>
                <a href="{{ url_for('class_mgmt.add_class') }}" class="btn btn-success">
                    <i class="fas fa-plus me-2"></i>
                    创建班级
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card quick-action-card h-100">
            <div class="card-body text-center">
                <div class="shortcut-icon-wrapper mb-3">
                    <div class="shortcut-icon warning-icon">
                        <i class="fas fa-users-cog"></i>
                    </div>
                    <div class="shortcut-glow warning-glow"></div>
                </div>
                <h5 class="card-title">管理班级</h5>
                <p class="card-text text-muted">管理所有班级，添加/移除学生</p>
                <a href="{{ url_for('class_mgmt.manage_classes') }}" class="btn btn-warning">
                    <i class="fas fa-cog me-2"></i>
                    管理班级
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card quick-action-card h-100">
            <div class="card-body text-center">
                <div class="shortcut-icon-wrapper mb-3">
                    <div class="shortcut-icon info-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <div class="shortcut-glow info-glow"></div>
                </div>
                <h5 class="card-title">添加学生</h5>
                <p class="card-text text-muted">创建新学生并分配到班级</p>
                <a href="{{ url_for('user_mgmt.add_user') }}" class="btn btn-info">
                    <i class="fas fa-user-plus me-2"></i>
                    添加学生
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 作业列表区域 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-gradient">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>
                        系统作业概览
                    </h5>
                    <button class="btn btn-info btn-sm" onclick="showBatchDownloadPage()">
                        <i class="fas fa-download me-2"></i>
                        批量下载
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- 班级筛选区域 -->
                {% if all_classes|length > 0 %}
                <div class="class-filter-section mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            <h6 class="mb-0">
                                <i class="fas fa-filter me-2"></i>
                                班级筛选
                            </h6>
                        </div>
                        <div class="col-md-10">
                            <div class="d-flex flex-wrap gap-2">
                                <button type="button" 
                                        onclick="filterAssignmentsByClass(null)" 
                                        class="btn btn-sm class-filter-btn {% if not selected_class_id %}btn-primary{% else %}btn-outline-primary{% endif %}" 
                                        data-class-id="">
                                    <i class="fas fa-globe me-1"></i>
                                    全部作业
                                    <span class="badge bg-light text-dark ms-1">{{ total_assignments }}</span>
                                </button>
                                {% for class_obj in all_classes %}
                                    <button type="button" 
                                            onclick="filterAssignmentsByClass({{ class_obj.id }})" 
                                            class="btn btn-sm class-filter-btn {% if selected_class_id == class_obj.id %}btn-primary{% else %}btn-outline-primary{% endif %}" 
                                            data-class-id="{{ class_obj.id }}">
                                        <i class="fas fa-school me-1"></i>
                                        {{ class_obj.name }}
                                        <span class="badge bg-light text-dark ms-1">
                                            {% set class_assignment_count = assignments|selectattr('class_id', 'equalto', class_obj.id)|list|length if not selected_class_id else assignments|length %}
                                            {{ class_assignment_count }}
                                        </span>
                                    </button>
                                {% endfor %}
                                <button type="button" 
                                        onclick="filterAssignmentsByClass(0)" 
                                        class="btn btn-sm class-filter-btn {% if selected_class_id == 0 %}btn-primary{% else %}btn-outline-primary{% endif %}" 
                                        data-class-id="0">
                                    <i class="fas fa-globe-americas me-1"></i>
                                    公共作业
                                    <span class="badge bg-light text-dark ms-1">
                                        {% set public_assignment_count = assignments|selectattr('class_id', 'none')|list|length if not selected_class_id else (assignments|length if selected_class_id == 0 else 0) %}
                                        {{ public_assignment_count }}
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if assignments %}
                    <div class="assignment-grid">
                        {% for assignment in assignments %}
                            <div class="assignment-card" data-class-id="{{ assignment.class_id if assignment.class_id else '0' }}">
                                <div class="assignment-header">
                                    <div class="assignment-icon">
                                        <i class="fas fa-file-text"></i>
                                    </div>
                                    <div class="assignment-status">
                                        {% if assignment.due_date %}
                                            {% if assignment.is_overdue() %}
                                                <span class="status-badge expired">
                                                    <i class="fas fa-times-circle"></i>
                                                    已截止
                                                </span>
                                            {% else %}
                                                <span class="status-badge active">
                                                    <i class="fas fa-check-circle"></i>
                                                    进行中
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            <span class="status-badge permanent">
                                                <i class="fas fa-infinity"></i>
                                                无限制
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="assignment-content">
                                    <h5 class="assignment-title">{{ assignment.title }}</h5>
                                    <p class="assignment-desc">创建者: {{ assignment.teacher.real_name }}</p>
                                    
                                    <div class="assignment-meta">
                                        <div class="meta-item">
                                            <i class="fas fa-upload"></i>
                                            <span>{{ assignment.submissions|length if assignment.submissions else 0 }} 提交</span>
                                        </div>
                                        {% if assignment.class_info %}
                                            <div class="meta-item">
                                                <i class="fas fa-school"></i>
                                                <span>{{ assignment.class_info.name }}</span>
                                            </div>
                                        {% else %}
                                            <div class="meta-item">
                                                <i class="fas fa-globe"></i>
                                                <span>公共作业</span>
                                            </div>
                                        {% endif %}
                                        {% if assignment.due_date %}
                                            <div class="meta-item">
                                                <i class="fas fa-clock"></i>
                                                <span>{{ assignment.due_date|beijing_short }}</span>
                                            </div>
                                            {% if not assignment.is_overdue() %}
                                                <div class="meta-item countdown-meta" data-due-time="{{ assignment.due_date.strftime('%Y-%m-%d %H:%M:%S') }}">
                                                    <i class="fas fa-hourglass-half"></i>
                                                    <span class="countdown-timer-admin text-primary"></span>
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                        <div class="meta-item">
                                            <i class="fas fa-calendar"></i>
                                            <span>{{ assignment.created_at|beijing_short }}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="assignment-actions d-flex flex-wrap gap-2">
                                    <a href="{{ url_for('assignment.view_submissions', assignment_id=assignment.id) }}" class="btn btn-primary btn-sm d-flex align-items-center">
                                        <i class="fas fa-eye me-1"></i>
                                        查看提交
                                    </a>
                                    <button class="btn btn-success btn-sm d-flex align-items-center" 
                                            onclick="showDownloadProgress({{ assignment.id }}, this)" 
                                            data-assignment-title="{{ assignment.title|replace('"', '&quot;')|replace("'", '&#x27;') }}">
                                        <i class="fas fa-download me-1"></i>
                                        下载
                                    </button>
                                    <a href="{{ url_for('assignment.edit_assignment', assignment_id=assignment.id) }}" class="btn btn-warning btn-sm d-flex align-items-center">
                                        <i class="fas fa-edit me-1"></i>
                                        编辑
                                    </a>
                                    <button class="btn btn-danger btn-sm d-flex align-items-center" 
                                            data-assignment-id="{{ assignment.id }}"
                                            data-assignment-title="{{ assignment.title }}"
                                            onclick="deleteAssignment(this.dataset.assignmentId, this.dataset.assignmentTitle)">
                                        <i class="fas fa-trash me-1"></i>
                                        删除
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-clipboard"></i>
                        </div>
                        <h3 class="empty-title">系统暂无作业</h3>
                        <p class="empty-desc">系统中还没有任何作业，请使用左侧菜单创建第一个作业</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>


<style>
/* 快速操作卡片样式 */
.quick-action-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
}

.quick-action-card:hover {
    transform: translateY(-10px) scale(1.02);
    box-shadow: 0 25px 50px var(--shadow-color);
    border-color: var(--accent-color);
}

.quick-action-card .shortcut-icon-wrapper {
    position: relative;
    display: inline-block;
}

.quick-action-card .shortcut-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: white;
    background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
    box-shadow: 0 10px 20px rgba(138, 43, 226, 0.3);
    transition: all 0.3s ease;
    margin: 0 auto;
}

.quick-action-card .success-icon {
    background: linear-gradient(135deg, #10B981, #34D399);
    box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
}

.quick-action-card .warning-icon {
    background: linear-gradient(135deg, #F59E0B, #FBBF24);
    box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3);
}

.quick-action-card .info-icon {
    background: linear-gradient(135deg, #3B82F6, #60A5FA);
    box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
}

.quick-action-card:hover .shortcut-icon {
    transform: rotate(10deg) scale(1.1);
}

.quick-action-card .shortcut-glow {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: -1;
}

.quick-action-card .success-glow {
    background: linear-gradient(135deg, #10B981, #34D399);
}

.quick-action-card .warning-glow {
    background: linear-gradient(135deg, #F59E0B, #FBBF24);
}

.quick-action-card .info-glow {
    background: linear-gradient(135deg, #3B82F6, #60A5FA);
}

.quick-action-card:hover .shortcut-glow {
    opacity: 0.3;
}

.quick-action-card .card-title {
    color: var(--text-primary);
    font-weight: 600;
}

.quick-action-card .btn {
    border-radius: 15px;
    padding: 10px 24px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.quick-action-card .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}
</style>

<!-- 删除作业确认模态框 -->
<div class="modal fade" id="deleteAssignmentModal" tabindex="-1" aria-labelledby="deleteAssignmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteAssignmentModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    确认删除作业
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-warning me-2"></i>
                    <strong>警告：</strong> 此操作不可逆转！
                </div>
                <p>您确定要删除作业 <strong id="assignmentToDelete"></strong> 吗？</p>
                <p class="text-muted mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    删除后将同时清除所有学生提交的文件和记录。
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    取消
                </button>
                <form id="deleteAssignmentForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>
                        确认删除
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 下载进度模态框 -->
<div class="modal fade" id="downloadProgressModal" tabindex="-1" aria-labelledby="downloadProgressModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="downloadProgressModalLabel">
                    <i class="fas fa-download me-2"></i>
                    正在下载作业
                </h5>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <h6 id="downloadAssignmentTitle" class="mb-3"></h6>
                    <div class="spinner-border text-primary mb-3" role="status" id="downloadSpinner">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                
                <!-- 进度条 -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">压缩进度</span>
                        <span id="downloadProgressPercent" class="fw-bold">0%</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div id="downloadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                
                <!-- 状态信息 -->
                <div class="alert alert-info mb-3">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="downloadStatusMessage">准备开始压缩...</span>
                    </div>
                </div>
                
                <!-- 详细信息 -->
                <div class="row text-center" id="downloadDetails" style="display: none;">
                    <div class="col-6">
                        <div class="border rounded p-2">
                            <div class="h6 mb-1"><span id="currentFileNumber">0</span> / <span id="totalFileNumber">0</span></div>
                            <small class="text-muted">文件进度</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-2">
                            <div class="h6 mb-1" id="estimatedTime">计算中...</div>
                            <small class="text-muted">预计剩余</small>
                        </div>
                    </div>
                </div>
                
                <!-- 成功状态 -->
                <div id="downloadSuccess" style="display: none;" class="text-center">
                    <div class="text-success mb-3">
                        <i class="fas fa-check-circle" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="text-success">压缩完成！</h5>
                    <p class="text-muted">文件即将开始下载...</p>
                </div>
                
                <!-- 错误状态 -->
                <div id="downloadError" style="display: none;" class="text-center">
                    <div class="text-danger mb-3">
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="text-danger">下载失败</h5>
                    <p id="downloadErrorMessage" class="text-muted"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="downloadCancelBtn" 
                        onclick="cancelDownload()" style="display: none;">
                    <i class="fas fa-times me-2"></i>
                    取消下载
                </button>
                <button type="button" class="btn btn-primary" id="downloadCloseBtn" 
                        data-bs-dismiss="modal" style="display: none;">
                    <i class="fas fa-check me-2"></i>
                    完成
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 统计卡片动画效果
document.addEventListener('DOMContentLoaded', function() {
    // 统计卡片动画
    const statCards = document.querySelectorAll('.stat-card');
    const assignmentCards = document.querySelectorAll('.assignment-card');
    
    // 统计卡片动画
    statCards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
            card.classList.add('fade-in-up');
        }, index * 100);
        
        // 添加悬停效果
        card.addEventListener('mouseenter', function() {
            const glow = this.querySelector('.shortcut-glow');
            if (glow) {
                glow.style.opacity = '0.3';
            }
        });
        
        card.addEventListener('mouseleave', function() {
            const glow = this.querySelector('.shortcut-glow');
            if (glow) {
                glow.style.opacity = '0';
            }
        });
    });
    
    // 作业卡片动画
    assignmentCards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 150 + 300); // 延迟300ms开始
    });
    
    // 欢迎卡片动画
    const welcomeCard = document.querySelector('.welcome-section');
    if (welcomeCard) {
        setTimeout(() => {
            welcomeCard.style.opacity = '1';
            welcomeCard.style.transform = 'translateY(0)';
        }, 100);
    }
    
    // 初始化倒计时
    initAdminCountdowns();
});

// 超级管理员页面倒计时功能
function initAdminCountdowns() {
    const countdownMetas = document.querySelectorAll('.countdown-meta');
    
    countdownMetas.forEach(meta => {
        const dueTimeStr = meta.getAttribute('data-due-time');
        const timer = meta.querySelector('.countdown-timer-admin');
        
        if (dueTimeStr && timer) {
            // 服务器传来的是UTC时间，直接使用
            const utcTime = new Date(dueTimeStr.replace(' ', 'T') + 'Z'); // Z表示UTC时间
            const dueTime = utcTime.getTime();
            
            function updateCountdown() {
                const now = new Date().getTime();
                const timeLeft = dueTime - now;
                
                if (timeLeft > 0) {
                    const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    
                    let countdownText = '';
                    if (days > 0) {
                        countdownText = `剩余${days}天`;
                    } else if (hours > 0) {
                        countdownText = `剩余${hours}小时`;
                    } else if (minutes > 0) {
                        countdownText = `剩余${minutes}分钟`;
                    } else {
                        countdownText = '即将截止';
                    }
                    
                    timer.textContent = countdownText;
                    
                    // 根据剩余时间改变颜色
                    if (timeLeft < 24 * 60 * 60 * 1000) { // 少于1天
                        timer.className = 'countdown-timer-admin text-danger';
                    } else if (timeLeft < 3 * 24 * 60 * 60 * 1000) { // 少于3天
                        timer.className = 'countdown-timer-admin text-warning';
                    } else {
                        timer.className = 'countdown-timer-admin text-primary';
                    }
                } else {
                    timer.textContent = '已截止';
                    timer.className = 'countdown-timer-admin text-danger';
                    meta.style.display = 'none'; // 隐藏已截止的倒计时
                }
            }
            
            // 立即更新一次
            updateCountdown();
            
            // 每分钟更新
            setInterval(updateCountdown, 60000);
        }
    });
}

// 统计数字动画效果
function animateNumbers() {
    const numbers = document.querySelectorAll('.stat-number');
    
    numbers.forEach(number => {
        const target = parseInt(number.textContent);
        const increment = target / 20;
        let current = 0;
        
        const timer = setInterval(() => {
            current += increment;
            number.textContent = Math.floor(current);
            
            if (current >= target) {
                number.textContent = target;
                clearInterval(timer);
            }
        }, 50);
    });
}

// 页面加载完成后启动数字动画
window.addEventListener('load', function() {
    setTimeout(animateNumbers, 800);
});

// 删除作业功能
function deleteAssignment(assignmentId, assignmentTitle) {
    document.getElementById('assignmentToDelete').textContent = assignmentTitle;
    document.getElementById('deleteAssignmentForm').action = `/admin/assignment/${assignmentId}/delete`;
    new bootstrap.Modal(document.getElementById('deleteAssignmentModal')).show();
}

// 下载进度相关功能
let downloadIntervalId = null;
let currentDownloadAssignmentId = null;

// 显示下载进度
function showDownloadProgress(assignmentId, buttonElement) {
    const assignmentTitle = buttonElement.getAttribute('data-assignment-title');
    currentDownloadAssignmentId = assignmentId;
    
    // 设置模态框标题
    document.getElementById('downloadAssignmentTitle').textContent = `正在下载: ${assignmentTitle}`;
    
    // 重置进度显示
    resetProgressModal();
    
    // 显示模态框
    new bootstrap.Modal(document.getElementById('downloadProgressModal')).show();
    
    // 开始下载并监控进度
    startDownload(assignmentId);
}

// 重置进度模态框
function resetProgressModal() {
    document.getElementById('downloadProgressBar').style.width = '0%';
    document.getElementById('downloadProgressBar').setAttribute('aria-valuenow', '0');
    document.getElementById('downloadProgressPercent').textContent = '0%';
    document.getElementById('downloadStatusMessage').textContent = '准备开始压缩...';
    document.getElementById('downloadSpinner').style.display = 'block';
    document.getElementById('downloadDetails').style.display = 'none';
    document.getElementById('downloadSuccess').style.display = 'none';
    document.getElementById('downloadError').style.display = 'none';
    document.getElementById('downloadCancelBtn').style.display = 'inline-block';
    document.getElementById('downloadCloseBtn').style.display = 'none';
}

// 开始下载
function startDownload(assignmentId) {
    // 开始监控进度
    downloadIntervalId = setInterval(() => {
        checkDownloadProgress(assignmentId);
    }, 500); // 每500ms检查一次进度
    
    // 触发实际下载（通过隐藏的iframe）
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = `/admin/assignment/${assignmentId}/download`;
    document.body.appendChild(iframe);
    
    // 10秒后移除iframe
    setTimeout(() => {
        if (iframe.parentNode) {
            iframe.parentNode.removeChild(iframe);
        }
    }, 10000);
}

// 检查下载进度
function checkDownloadProgress(assignmentId) {
    fetch(`/admin/assignment/${assignmentId}/download_status`)
        .then(response => response.json())
        .then(data => {
            updateProgressUI(data);
            
            // 如果完成或出错，停止监控
            if (data.status === 'completed' || data.status === 'error') {
                if (downloadIntervalId) {
                    clearInterval(downloadIntervalId);
                    downloadIntervalId = null;
                }
            }
        })
        .catch(error => {
            console.error('检查进度失败:', error);
            if (downloadIntervalId) {
                clearInterval(downloadIntervalId);
                downloadIntervalId = null;
            }
            showDownloadError('网络错误，无法获取下载进度');
        });
}

// 更新进度UI
function updateProgressUI(data) {
    const progressBar = document.getElementById('downloadProgressBar');
    const progressPercent = document.getElementById('downloadProgressPercent');
    const statusMessage = document.getElementById('downloadStatusMessage');
    const spinner = document.getElementById('downloadSpinner');
    const details = document.getElementById('downloadDetails');
    
    // 更新进度条
    progressBar.style.width = `${data.progress}%`;
    progressBar.setAttribute('aria-valuenow', data.progress);
    progressPercent.textContent = `${data.progress}%`;
    
    // 更新状态消息
    statusMessage.textContent = data.message || '正在处理...';
    
    // 根据状态更新UI
    switch (data.status) {
        case 'processing':
            spinner.style.display = 'block';
            if (data.current_file && data.total_files) {
                details.style.display = 'block';
                document.getElementById('currentFileNumber').textContent = data.current_file;
                document.getElementById('totalFileNumber').textContent = data.total_files;
                
                // 计算预计剩余时间（简单估算）
                if (data.progress > 0) {
                    const elapsed = (Date.now() - downloadStartTime) / 1000;
                    const estimated = (elapsed / data.progress * 100) - elapsed;
                    document.getElementById('estimatedTime').textContent = formatTime(estimated);
                } else {
                    document.getElementById('estimatedTime').textContent = '计算中...';
                }
            }
            break;
            
        case 'completed':
            showDownloadSuccess();
            break;
            
        case 'error':
            showDownloadError(data.message || '下载过程中发生未知错误');
            break;
    }
}

// 显示下载成功
function showDownloadSuccess() {
    document.getElementById('downloadSpinner').style.display = 'none';
    document.getElementById('downloadDetails').style.display = 'none';
    document.getElementById('downloadSuccess').style.display = 'block';
    document.getElementById('downloadCancelBtn').style.display = 'none';
    document.getElementById('downloadCloseBtn').style.display = 'inline-block';
    
    // 3秒后自动关闭模态框
    setTimeout(() => {
        const modal = bootstrap.Modal.getInstance(document.getElementById('downloadProgressModal'));
        if (modal) {
            modal.hide();
        }
    }, 3000);
}

// 显示下载错误
function showDownloadError(message) {
    document.getElementById('downloadSpinner').style.display = 'none';
    document.getElementById('downloadDetails').style.display = 'none';
    document.getElementById('downloadError').style.display = 'block';
    document.getElementById('downloadErrorMessage').textContent = message;
    document.getElementById('downloadCancelBtn').style.display = 'none';
    document.getElementById('downloadCloseBtn').style.display = 'inline-block';
}

// 取消下载
function cancelDownload() {
    if (downloadIntervalId) {
        clearInterval(downloadIntervalId);
        downloadIntervalId = null;
    }
    
    // 关闭模态框
    const modal = bootstrap.Modal.getInstance(document.getElementById('downloadProgressModal'));
    if (modal) {
        modal.hide();
    }
}

// 格式化时间
function formatTime(seconds) {
    if (seconds < 60) {
        return `${Math.round(seconds)}秒`;
    } else if (seconds < 3600) {
        return `${Math.round(seconds / 60)}分钟`;
    } else {
        return `${Math.round(seconds / 3600)}小时`;
    }
}

// 记录下载开始时间
let downloadStartTime = Date.now();

// 显示批量下载页面
function showBatchDownloadPage() {
    window.location.href = '{{ url_for("download.batch_download_assignments") }}';
}

// 班级筛选功能（无刷新）
function filterAssignmentsByClass(classId) {
    // 更新按钮状态
    document.querySelectorAll('.class-filter-btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
    });
    
    // 高亮当前选中的按钮
    event.target.closest('button').classList.remove('btn-outline-primary');
    event.target.closest('button').classList.add('btn-primary');
    
    // 筛选作业卡片
    const assignmentCards = document.querySelectorAll('.assignment-card');
    
    assignmentCards.forEach(card => {
        const cardClassId = card.getAttribute('data-class-id');
        
        if (classId === null || classId === '') {
            // 显示所有作业
            card.style.display = '';
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            setTimeout(() => {
                card.style.transition = 'all 0.3s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 50);
        } else if (classId === 0) {
            // 筛选公共作业（class_id 为 '0'）
            if (cardClassId === '0') {
                card.style.display = '';
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.3s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 50);
            } else {
                card.style.display = 'none';
            }
        } else if (cardClassId === String(classId)) {
            // 显示指定班级的作业
            card.style.display = '';
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            setTimeout(() => {
                card.style.transition = 'all 0.3s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 50);
        } else {
            card.style.display = 'none';
        }
    });
    
    // 检查是否有可见的作业
    const visibleCards = Array.from(assignmentCards).filter(card => card.style.display !== 'none');
    const emptyState = document.querySelector('.empty-state');
    const assignmentGrid = document.querySelector('.assignment-grid');
    
    if (visibleCards.length === 0) {
        if (assignmentGrid) assignmentGrid.style.display = 'none';
        if (!emptyState) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'empty-state';
            emptyDiv.innerHTML = `
                <div class="empty-icon">
                    <i class="fas fa-clipboard"></i>
                </div>
                <h3 class="empty-title">该筛选条件下暂无作业</h3>
                <p class="empty-desc">当前筛选条件下没有找到任何作业</p>
            `;
            document.querySelector('.card-body').appendChild(emptyDiv);
        }
    } else {
        if (assignmentGrid) assignmentGrid.style.display = '';
        if (emptyState) emptyState.remove();
    }
}
</script>

<style>
/* 统计卡片样式 - 恢复原来的快捷操作风格 */
.stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    padding: 2rem;
    height: 100%;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    opacity: 0;
    transform: translateY(30px);
}

.stat-card.fade-in-up {
    opacity: 1;
    transform: translateY(0);
}

.stat-card:hover {
    transform: translateY(-10px) scale(1.02);
    box-shadow: 0 25px 50px var(--shadow-color);
    border-color: var(--accent-color);
}

.shortcut-icon-wrapper {
    position: relative;
    display: inline-block;
    margin-bottom: 1.5rem;
}

.shortcut-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent-color), #17a2b8);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    color: white;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
    position: relative;
    z-index: 2;
}

.shortcut-icon.warning-icon {
    background: linear-gradient(135deg, var(--warning-color), #fbb040);
    box-shadow: 0 10px 30px rgba(237, 137, 54, 0.3);
}

.shortcut-icon.success-icon {
    background: linear-gradient(135deg, var(--success-color), #68d391);
    box-shadow: 0 10px 30px rgba(72, 187, 120, 0.3);
}

.shortcut-icon.danger-icon {
    background: linear-gradient(135deg, var(--danger-color), #fc8181);
    box-shadow: 0 10px 30px rgba(245, 101, 101, 0.3);
}

.shortcut-glow {
    position: absolute;
    top: -10px;
    left: -10px;
    right: -10px;
    bottom: -10px;
    background: linear-gradient(135deg, var(--accent-color), #17a2b8);
    border-radius: 50%;
    opacity: 0;
    filter: blur(20px);
    transition: opacity 0.3s ease;
    z-index: 1;
}

.shortcut-glow.warning-glow {
    background: linear-gradient(135deg, var(--warning-color), #fbb040);
}

.shortcut-glow.success-glow {
    background: linear-gradient(135deg, var(--success-color), #68d391);
}

.shortcut-glow.danger-glow {
    background: linear-gradient(135deg, var(--danger-color), #fc8181);
}

.stat-card:hover .shortcut-icon {
    transform: scale(1.1) rotate(10deg);
}

.stat-card:hover .shortcut-glow {
    opacity: 0.3;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 800;
    margin: 0;
    background: linear-gradient(135deg, var(--accent-color), #17a2b8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stat-number.warning-text {
    background: linear-gradient(135deg, var(--warning-color), #fbb040);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stat-number.success-text {
    background: linear-gradient(135deg, var(--success-color), #68d391);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stat-number.danger-text {
    background: linear-gradient(135deg, var(--danger-color), #fc8181);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stat-label {
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 0.95rem;
}

/* 倒计时样式 */
.countdown-meta {
    margin-top: 0.5rem;
}

.countdown-timer-admin {
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    font-weight: 600;
    padding: 0.1rem 0.3rem;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 3px;
    border: 1px solid rgba(0, 0, 0, 0.1);
}

/* 初始化动画状态 */
.assignment-card,
.welcome-section {
    opacity: 0;
    transform: translateY(30px);
    transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* 悬停效果增强 */
.assignment-card:hover .assignment-icon {
    transform: scale(1.1) rotate(5deg);
    transition: all 0.3s ease;
}

/* 响应式布局优化 */
@media (max-width: 768px) {
    .stat-card {
        padding: 1.5rem;
    }
    
    .shortcut-icon {
        width: 60px;
        height: 60px;
        font-size: 2rem;
    }
    
    .stat-number {
        font-size: 2rem;
    }
    
    .assignment-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .class-filter-section .d-flex {
        flex-direction: column;
    }
    
    .class-filter-section .btn {
        width: 100%;
        justify-content: space-between;
    }
}

/* 班级筛选样式 */
.class-filter-section {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 1.5rem;
    border-radius: 15px;
    border: 2px solid #667eea;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
}

.class-filter-section h6 {
    color: #495057;
    font-weight: 600;
    margin-bottom: 0;
}

.class-filter-section .btn-outline-primary {
    border-color: #667eea;
    color: #495057;
    background: white;
    transition: all 0.3s ease;
    font-weight: 500;
}

.class-filter-section .btn-outline-primary:hover {
    background: #667eea;
    border-color: #667eea;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
}

.class-filter-section .btn-primary {
    background: #667eea;
    border-color: #667eea;
    color: white;
    font-weight: 600;
    box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
}

.class-filter-section .btn-primary:hover {
    background: #5568d3;
    border-color: #5568d3;
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(102, 126, 234, 0.5);
}

.class-filter-section .badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    background: #e9ecef !important;
    color: #495057 !important;
    font-weight: 600;
}

.class-filter-section .btn-primary .badge {
    background: rgba(255, 255, 255, 0.3) !important;
    color: white !important;
}

@media (max-width: 480px) {
    .stat-number {
        font-size: 1.8rem;
    }
    
    .shortcut-icon {
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
    }
}
</style>
{% endblock %}