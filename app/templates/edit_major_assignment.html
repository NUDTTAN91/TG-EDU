{% extends "base.html" %}

{% block title %}编辑大作业 - TG作业系统{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-edit me-2"></i>
                        编辑大作业
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
                        <!-- 作业标题 -->
                        <div class="mb-3">
                            <label for="title" class="form-label">
                                <i class="fas fa-heading me-1"></i>作业标题 <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="title" name="title" 
                                   value="{{ major_assignment.title }}" required>
                        </div>

                        <!-- 作业描述 -->
                        <div class="mb-3">
                            <label for="description" class="form-label">
                                <i class="fas fa-align-left me-1"></i>作业描述
                            </label>
                            <textarea class="form-control" id="description" name="description" rows="4">{{ major_assignment.description or '' }}</textarea>
                        </div>

                        <!-- 选择班级 -->
                        <div class="mb-3">
                            <label for="class_id" class="form-label">
                                <i class="fas fa-school me-1"></i>选择班级 <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="class_id" name="class_id" required disabled>
                                <option value="{{ major_assignment.class_id }}">{{ major_assignment.class_info.name }}</option>
                            </select>
                            <small class="text-muted">班级信息不可修改</small>
                        </div>

                        <!-- 管理教师（仅超级管理员和创建者可见） -->
                        {% if current_user.is_super_admin or current_user.id == major_assignment.creator_id %}
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-chalkboard-teacher me-1"></i>管理教师
                            </label>
                            <small class="text-muted d-block mb-2">可以选择多个教师管理此大作业</small>
                            
                            <!-- 搜索框 -->
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="teacher_search" 
                                       placeholder="输入教师姓名或用户名搜索..." autocomplete="off">
                                <button type="button" class="btn btn-outline-secondary" id="clear_search">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <!-- 搜索结果下拉列表（点击添加） -->
                            <div id="search_results" class="list-group mb-3" style="display: none; max-height: 200px; overflow-y: auto;"></div>
                            
                            <!-- 已选择的教师（显示为标签） -->
                            <div class="mb-2">
                                <label class="form-label small text-muted">已选择的教师:</label>
                                <div id="selected_teachers" class="d-flex flex-wrap gap-2">
                                    <span class="text-muted">暂无</span>
                                </div>
                            </div>
                            
                            <!-- 隐藏的input用于提交表单 -->
                            <div id="teacher_inputs"></div>
                            
                            <!-- 所有教师数据（用于JavaScript搜索） -->
                            <script>
                                window.allTeachers = [
                                    {% for teacher in teachers %}
                                    {
                                        id: {{ teacher.id }},
                                        name: '{{ teacher.real_name }}',
                                        username: '{{ teacher.username }}'
                                    }{% if not loop.last %},{% endif %}
                                    {% endfor %}
                                ];
                                
                                // 已选择的教师
                                window.initialSelectedTeachers = [
                                    {% for teacher in major_assignment.teachers %}
                                    {{ teacher.id }}{% if not loop.last %},{% endif %}
                                    {% endfor %}
                                ];
                            </script>
                        </div>
                        {% endif %}

                        <!-- 组队人数设置 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="min_team_size" class="form-label">
                                    <i class="fas fa-users me-1"></i>最小组队人数 <span class="text-danger">*</span>
                                </label>
                                <input type="number" class="form-control" id="min_team_size" 
                                       name="min_team_size" value="{{ major_assignment.min_team_size }}" min="1" required>
                            </div>
                            <div class="col-md-6">
                                <label for="max_team_size" class="form-label">
                                    <i class="fas fa-users me-1"></i>最大组队人数 <span class="text-danger">*</span>
                                </label>
                                <input type="number" class="form-control" id="max_team_size" 
                                       name="max_team_size" value="{{ major_assignment.max_team_size }}" min="1" required>
                            </div>
                        </div>

                        <!-- 当前作业要求 -->
                        {% if major_assignment.requirement_file_path or major_assignment.requirement_url %}
                        <div class="alert alert-info mb-3">
                            <strong>当前作业要求：</strong><br>
                            {% if major_assignment.requirement_file_path %}
                            <i class="fas fa-file me-1"></i>文件：{{ major_assignment.requirement_file_name }}
                            <a href="{{ url_for('major_assignment.download_major_assignment_requirement', assignment_id=major_assignment.id) }}" 
                               class="btn btn-sm btn-outline-primary ms-2">
                                <i class="fas fa-download"></i> 下载
                            </a>
                            {% elif major_assignment.requirement_url %}
                            <i class="fas fa-link me-1"></i>链接：
                            <a href="{{ major_assignment.requirement_url }}" target="_blank">
                                {{ major_assignment.requirement_url }}
                            </a>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- 更新作业要求（文件或链接） -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-file-alt me-1"></i>更新作业要求（可选）
                            </label>
                            <div class="mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="requirement_type" 
                                           id="req_file" value="file" checked onclick="toggleRequirementType('file')">
                                    <label class="form-check-label" for="req_file">
                                        上传新文件
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="requirement_type" 
                                           id="req_url" value="url" onclick="toggleRequirementType('url')">
                                    <label class="form-check-label" for="req_url">
                                        提供新链接
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="requirement_type" 
                                           id="req_none" value="none" onclick="toggleRequirementType('none')">
                                    <label class="form-check-label" for="req_none">
                                        保持不变
                                    </label>
                                </div>
                            </div>
                            
                            <div id="file_upload_section" style="display: none;">
                                <input type="file" class="form-control" id="requirement_file" name="requirement_file">
                                <small class="form-text text-muted">支持PDF、Word、图片等格式</small>
                            </div>
                            
                            <div id="url_input_section" style="display: none;">
                                <input type="url" class="form-control" id="requirement_url" 
                                       name="requirement_url" placeholder="https://example.com/assignment">
                                <small class="form-text text-muted">请输入完整的URL地址</small>
                            </div>
                        </div>

                        <!-- 作业日期设置 -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-calendar-check me-1"></i>作业时间设置
                            </label>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="start_date" class="form-label">开始日期</label>
                                    <input type="datetime-local" class="form-control" id="start_date" name="start_date"
                                           value="{% if start_date_beijing %}{{ start_date_beijing.strftime('%Y-%m-%dT%H:%M') }}{% endif %}">
                                    <small class="form-text text-muted">作业开始时间</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="end_date" class="form-label">结束日期</label>
                                    <input type="datetime-local" class="form-control" id="end_date" name="end_date"
                                           value="{% if end_date_beijing %}{{ end_date_beijing.strftime('%Y-%m-%dT%H:%M') }}{% endif %}">
                                    <small class="form-text text-muted">作业结束时间</small>
                                </div>
                                <div class="col-md-12">
                                    <label for="due_date" class="form-label">截止时间</label>
                                    <input type="datetime-local" class="form-control" id="due_date" name="due_date"
                                           value="{% if due_date_beijing %}{{ due_date_beijing.strftime('%Y-%m-%dT%H:%M') }}{% endif %}">
                                    <small class="form-text text-muted">留空表示无截止时间</small>
                                </div>
                            </div>
                            <div class="alert alert-info py-2 small mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>说明：</strong>开始日期必须早于结束日期，所有阶段必须在开始和结束日期之间
                            </div>
                        </div>

                        <!-- 提交按钮 -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('major_assignment.major_assignment_dashboard') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i>返回
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>保存修改
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleRequirementType(type) {
    const fileSection = document.getElementById('file_upload_section');
    const urlSection = document.getElementById('url_input_section');
    const fileInput = document.getElementById('requirement_file');
    const urlInput = document.getElementById('requirement_url');
    
    if (type === 'file') {
        fileSection.style.display = 'block';
        urlSection.style.display = 'none';
        fileInput.required = false;
        urlInput.required = false;
        urlInput.value = '';
    } else if (type === 'url') {
        fileSection.style.display = 'none';
        urlSection.style.display = 'block';
        fileInput.required = false;
        urlInput.required = false;
        fileInput.value = '';
    } else {
        fileSection.style.display = 'none';
        urlSection.style.display = 'none';
        fileInput.required = false;
        urlInput.required = false;
        fileInput.value = '';
        urlInput.value = '';
    }
}

// 教师选择功能
if (typeof window.allTeachers !== 'undefined') {
    const selectedTeachers = new Set(window.initialSelectedTeachers || []);
    const teacherSearch = document.getElementById('teacher_search');
    const searchResults = document.getElementById('search_results');
    const selectedTeachersDiv = document.getElementById('selected_teachers');
    const teacherInputsDiv = document.getElementById('teacher_inputs');
    const clearSearchBtn = document.getElementById('clear_search');
    
    // 初始化显示已选教师
    updateSelectedTeachersUI();
    
    // 搜索功能
    teacherSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        
        if (searchTerm === '') {
            searchResults.style.display = 'none';
            searchResults.innerHTML = '';
            return;
        }
        
        const filtered = window.allTeachers.filter(t => {
            return !selectedTeachers.has(t.id) && 
                   (t.name.toLowerCase().includes(searchTerm) || 
                    t.username.toLowerCase().includes(searchTerm));
        });
        
        if (filtered.length > 0) {
            searchResults.innerHTML = filtered.map(t => `
                <a href="#" class="list-group-item list-group-item-action" data-id="${t.id}" data-name="${t.name}" data-username="${t.username}">
                    <i class="fas fa-user-plus me-2"></i>${t.name} (${t.username})
                </a>
            `).join('');
            searchResults.style.display = 'block';
        } else {
            searchResults.innerHTML = '<div class="list-group-item text-muted">没有找到匹配的教师</div>';
            searchResults.style.display = 'block';
        }
    });
    
    // 清空搜索
    clearSearchBtn.addEventListener('click', function() {
        teacherSearch.value = '';
        searchResults.style.display = 'none';
        searchResults.innerHTML = '';
    });
    
    // 点击搜索结果添加教师
    searchResults.addEventListener('click', function(e) {
        e.preventDefault();
        const item = e.target.closest('a[data-id]');
        if (!item) return;
        
        const id = parseInt(item.dataset.id);
        const name = item.dataset.name;
        const username = item.dataset.username;
        
        addTeacher(id, name, username);
        
        teacherSearch.value = '';
        searchResults.style.display = 'none';
        searchResults.innerHTML = '';
    });
    
    // 添加教师
    function addTeacher(id, name, username) {
        if (selectedTeachers.has(id)) return;
        
        selectedTeachers.add(id);
        updateSelectedTeachersUI();
    }
    
    // 移除教师
    function removeTeacher(id) {
        selectedTeachers.delete(id);
        updateSelectedTeachersUI();
    }
    
    // 更新UI
    function updateSelectedTeachersUI() {
        if (selectedTeachers.size === 0) {
            selectedTeachersDiv.innerHTML = '<span class="text-muted">暂无</span>';
            teacherInputsDiv.innerHTML = '';
            return;
        }
        
        const tags = Array.from(selectedTeachers).map(id => {
            const teacher = window.allTeachers.find(t => t.id === id);
            return `
                <span class="badge bg-primary" style="font-size: 0.9rem; padding: 0.5rem 0.75rem;">
                    ${teacher.name} (${teacher.username})
                    <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.7rem;" 
                            onclick="removeTeacher(${id})" aria-label="移除"></button>
                </span>
            `;
        }).join('');
        
        const inputs = Array.from(selectedTeachers).map(id => 
            `<input type="hidden" name="teacher_ids" value="${id}">`
        ).join('');
        
        selectedTeachersDiv.innerHTML = tags;
        teacherInputsDiv.innerHTML = inputs;
    }
    
    // 全局函数，供标签中的删除按钮调用
    window.removeTeacher = removeTeacher;
}

// 页面加载时默认选中“保持不变”
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('req_none').checked = true;
    toggleRequirementType('none');
});

// 验证组队人数
document.querySelector('form').addEventListener('submit', function(e) {
    const minSize = parseInt(document.getElementById('min_team_size').value);
    const maxSize = parseInt(document.getElementById('max_team_size').value);
    
    if (minSize > maxSize) {
        e.preventDefault();
        alert('最小组队人数不能大于最大组队人数！');
        return false;
    }
    
    if (minSize < 1 || maxSize < 1) {
        e.preventDefault();
        alert('组队人数必须大于0！');
        return false;
    }
});
</script>
{% endblock %}
