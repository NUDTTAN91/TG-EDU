# TG-EDU 阶段管理系统 - 测试指南

## 🎯 测试目标

全面测试阶段管理系统的三种阶段类型和所有自动处理逻辑。

## 📋 测试前准备

### 1. 登录系统
- 访问：http://localhost
- 管理员账号：
  - 用户名：`root`
  - 密码：`Root@123`

### 2. 创建测试数据

#### A. 创建班级
1. 点击顶部菜单"班级管理"
2. 点击"创建班级"
3. 填写：
   - 班级名称：`测试班级2025`
   - 班级描述：`用于测试阶段管理功能`
4. 点击"创建"

#### B. 创建学生账号（至少6个）
1. 点击"用户管理"
2. 点击"创建用户"
3. 创建以下学生（重复6次）：
   - 用户名：`student1` ~ `student6`
   - 密码：`123456`
   - 真实姓名：`学生1` ~ `学生6`
   - 学号：`2025001` ~ `2025006`
   - 角色：学生
   - 班级：选择刚创建的测试班级

#### C. 创建教师账号
1. 创建教师用户：
   - 用户名：`teacher1`
   - 密码：`123456`
   - 真实姓名：`测试教师`
   - 角色：教师

## 🧪 测试场景

### 场景一：完整的组队阶段测试

#### 步骤1：创建大作业（教师操作）
1. 使用教师账号登录（或管理员）
2. 点击顶部"大作业"
3. 点击"创建大作业"
4. 填写：
   - 作业标题：`软件工程大作业`
   - 作业描述：`完成一个小型项目`
   - 选择班级：`测试班级2025`
   - 管理教师：选择自己
   - 组队人数：最小 2 人，最大 3 人
   - **开始日期**：今天的日期和时间
   - **结束日期**：明天的日期和时间
   - 截止时间：后天的日期和时间
5. 点击"创建"

#### 步骤2：创建组队阶段
1. 进入刚创建的大作业
2. 点击"查看分组情况"
3. 点击"阶段管理"
4. 点击"添加阶段"
5. 填写：
   - 阶段名称：`组队阶段`
   - 阶段类型：选择"组队阶段"
   - 阶段描述：`学生自由组队，未组队者将被自动分组`
   - **开始时间**：当前时间
   - **结束时间**：5分钟后的时间（方便测试）
6. 点击"创建阶段"

#### 步骤3：学生组队（部分学生）
1. **登出教师账号**
2. 使用 `student1` 登录
3. 点击顶部"大作业"，进入"软件工程大作业"
4. 点击"创建团队"
5. 点击"邀请成员"
6. 填写：
   - 姓名：`学生2`
   - 学号：`2025002`
7. 点击"发送邀请"

8. **登出 student1**，使用 `student2` 登录
9. 点击顶部的通知图标（小铃铛）
10. 找到团队邀请，点击"接受"

11. **使用 student3 和 student4 重复步骤1-10**，创建另一个团队

#### 步骤4：请求确认（组长操作）
1. 使用 `student1` 登录
2. 进入大作业详情
3. 点击"请求确认"按钮
4. 在弹出框中点击"发送请求"

#### 步骤5：教师确认团队
1. 使用教师账号登录
2. 进入大作业 → 查看分组情况
3. 找到请求确认的团队（蓝色边框）
4. 点击"确认"按钮

#### 步骤6：测试自动分组
**保持 student5 和 student6 未组队**

1. 使用教师账号登录
2. 进入"阶段管理"
3. **方式1：手动完成阶段**
   - 找到"组队阶段"
   - 点击"立即结束"
   - 确认操作

   **方式2：等待时间到期（如果设置了5分钟后）**
   - 点击"更新阶段状态"按钮
   - 或运行：`docker exec tg-edu-system python3 update_stage_status.py`

4. 返回"查看分组情况"
5. **验证结果**：
   - ✅ 应该看到一个新的团队（系统自动创建）
   - ✅ student5 和 student6 应该在这个团队中
   - ✅ 团队状态应该是"已确认"并且"已锁定"

6. 使用 `student5` 或 `student6` 登录
7. 查看通知，应该收到"系统自动分组"的通知
8. 进入大作业详情，应该看到已加入团队

### 场景二：完整的分工阶段测试

#### 步骤1：创建分工阶段
1. 使用教师账号登录
2. 进入"阶段管理"
3. 点击"添加阶段"
4. 填写：
   - 阶段名称：`任务分工阶段`
   - 阶段类型：选择"分工阶段"
   - 阶段描述：`为团队成员分配具体职责`
   - 开始时间：当前时间
   - 结束时间：10分钟后
5. 点击"创建阶段"

#### 步骤2：创建分工角色
1. 找到刚创建的"任务分工阶段"
2. 点击"管理分工角色"
3. 点击"添加角色"
4. 创建以下角色：
   
   **角色1：**
   - 角色名称：`项目经理`
   - 角色描述：`负责项目整体规划和进度管理`
   - ✅ 勾选"必须角色"
   
   **角色2：**
   - 角色名称：`开发工程师`
   - 角色描述：`负责代码编写和功能实现`
   - ✅ 勾选"必须角色"
   
   **角色3：**
   - 角色名称：`测试工程师`
   - 角色描述：`负责测试和质量保证`
   - ❌ 不勾选（可选角色）

#### 步骤3：组长分配角色（部分分配）
1. 使用 `student1` 登录（第一个团队的组长）
2. 进入大作业详情
3. 在"团队分工"卡片中找到"任务分工阶段"
4. 点击"分配角色"
5. 分配角色：
   - 项目经理：选择 `学生1`（组长自己）
   - 开发工程师：**留空不分配**（测试自动分配）
   - 测试工程师：可选角色，可以分配或不分配
6. 点击"保存分配"

#### 步骤4：测试自动分配角色
1. 使用教师账号登录
2. 进入"阶段管理"
3. 找到"任务分工阶段"
4. 点击"立即结束"
5. 确认操作

6. **验证结果**：
   - 使用 `student1` 登录
   - 进入大作业详情
   - 查看"团队分工"
   - ✅ "开发工程师"角色应该已经被自动分配给 student2
   - ✅ student2 应该收到"系统自动分配角色"的通知

### 场景三：自定义阶段测试

#### 步骤1：创建多个自定义阶段
1. 使用教师账号登录
2. 进入"阶段管理"
3. 创建以下阶段：

   **阶段1：需求分析**
   - 类型：自定义阶段
   - 时间：当前 ~ 1天后
   
   **阶段2：系统设计**
   - 类型：自定义阶段
   - 时间：1天后 ~ 2天后
   
   **阶段3：编码实现**
   - 类型：自定义阶段
   - 时间：2天后 ~ 3天后

#### 步骤2：验证阶段顺序和状态
1. 在"阶段管理"页面查看所有阶段
2. ✅ 应该按照创建顺序（order字段）排列
3. ✅ 第一个阶段应该是"进行中"（active）
4. ✅ 后面的阶段应该是"待开始"（pending）

### 场景四：阶段状态转换测试

#### 测试手动激活
1. 创建一个未来时间开始的阶段
2. 点击"立即激活"
3. ✅ 状态应该变为"进行中"

#### 测试手动完成
1. 对于"进行中"的阶段
2. 点击"立即结束"
3. ✅ 状态应该变为"已完成"

#### 测试批量更新
1. 点击"更新阶段状态"按钮
2. ✅ 所有过期的阶段应该自动完成
3. ✅ 所有到期开始的阶段应该自动激活

## ✅ 验证检查清单

### 组队阶段
- [ ] 学生可以创建团队
- [ ] 学生可以邀请成员
- [ ] 组长可以请求确认
- [ ] 教师可以确认团队
- [ ] 确认后团队被锁定
- [ ] 未组队学生被自动分组
- [ ] 自动创建的团队被确认并锁定
- [ ] 所有人收到相应通知

### 分工阶段
- [ ] 教师可以创建分工角色
- [ ] 可以设置必须/可选角色
- [ ] 组长可以分配角色
- [ ] 必须角色强制要求分配
- [ ] 未分配的必须角色被自动分配
- [ ] 被分配的成员收到通知

### 自定义阶段
- [ ] 可以创建自定义阶段
- [ ] 阶段按顺序显示
- [ ] 可以编辑和删除阶段

### 权限控制
- [ ] 学生无法访问阶段管理
- [ ] 学生无法管理角色
- [ ] 非组长无法分配角色
- [ ] 锁定的团队无法修改分工

### 时间和状态
- [ ] 阶段自动从pending变为active
- [ ] 阶段自动从active变为completed
- [ ] 手动激活功能正常
- [ ] 手动完成功能正常
- [ ] 批量更新功能正常

### 数据完整性
- [ ] 删除角色时级联删除分配
- [ ] 阶段时间必须在大作业范围内
- [ ] 必须角色验证生效
- [ ] 人数验证生效

### 用户体验
- [ ] 界面清晰友好
- [ ] 提示信息准确
- [ ] 错误处理得当
- [ ] 通知及时送达

## 🐛 已知问题和限制

1. **定时任务未配置**
   - 需要手动设置 cron 任务或点击"更新阶段状态"按钮
   - 可以运行：`docker exec tg-edu-system python3 update_stage_status.py`

2. **阶段完成不可撤销**
   - 一旦阶段完成并执行了自动处理，无法撤销
   - 建议谨慎使用"立即结束"功能

3. **自动分组人数**
   - 系统会尽量满足最大人数要求
   - 最后一个团队可能人数不足

## 📞 测试反馈

测试过程中如遇到问题，请记录：
1. 操作步骤
2. 预期结果
3. 实际结果
4. 截图或错误信息

## 🎉 测试完成

完成所有测试后，您应该能够：
- ✅ 理解三种阶段类型的用途
- ✅ 熟练创建和管理阶段
- ✅ 了解自动处理逻辑的工作原理
- ✅ 掌握完整的大作业管理流程

祝测试顺利！ 🚀
