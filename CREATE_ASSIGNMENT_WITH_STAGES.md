# 创建大作业时预设阶段功能说明

## 功能概述

在创建大作业时，教师可以**预先设置阶段**，无需在创建后再单独添加。这简化了大作业的初始化流程。

## 使用方法

### 步骤1：填写基本信息
1. 进入"大作业管理" → 点击"布置大作业"
2. 填写作业标题、描述、选择班级等基本信息
3. 设置组队人数范围
4. 上传作业要求文件或提供链接

### 步骤2：设置作业时间
1. **开始日期**：学生可以开始组队的时间
2. **结束日期**：大作业的最终截止时间
3. **提交截止时间**（可选）：作业提交的具体截止时间

> ⚠️ **重要**：所有阶段的时间必须在开始日期和结束日期之间

### 步骤3：预设阶段（可选）

#### 组队阶段
- **功能**：学生自由组队
- **自动处理**：阶段结束时，系统自动为未组队的学生创建团队
- **设置项**：
  - ✅ 勾选"添加组队阶段"
  - 设置"组队开始时间"
  - 设置"组队结束时间"

**示例设置**：
```
开始日期：2025-10-20 08:00
结束日期：2025-12-31 23:59

组队阶段：
  开始时间：2025-10-20 08:00
  结束时间：2025-10-27 23:59
```

#### 分工阶段
- **功能**：团队成员分配角色
- **自动处理**：阶段结束时，系统自动为未分配的必须角色随机分配成员
- **设置项**：
  - ✅ 勾选"添加分工阶段"
  - 设置"分工开始时间"
  - 设置"分工结束时间"

> 📝 **注意**：分工阶段的角色需要在创建后，进入"阶段管理"→"管理分工角色"中添加

**示例设置**：
```
分工阶段：
  开始时间：2025-10-28 00:00
  结束时间：2025-11-03 23:59
```

### 步骤4：提交创建
点击"布置大作业"按钮，系统将：
1. ✅ 创建大作业
2. ✅ 自动创建勾选的阶段
3. ✅ 发送通知给班级学生
4. ✅ 阶段自动按时间开始和结束

## 阶段时间建议

### 推荐时间安排
```
大作业时间：10周（70天）

阶段1 - 组队阶段：第1周（7天）
  └─ 学生自由组队，教师审核团队

阶段2 - 分工阶段：第2周（7天）  
  └─ 组长分配团队成员角色

阶段3-8 - 自定义阶段：第3-10周（56天）
  └─ 需求分析、设计、开发、测试等
  └─ 可在创建后通过"阶段管理"添加
```

### 时间验证规则
1. ✅ 组队开始时间 < 组队结束时间
2. ✅ 分工开始时间 < 分工结束时间
3. ✅ 所有阶段时间必须在大作业的开始和结束日期之间
4. ⚠️ 建议阶段之间不要重叠（系统不强制）

## 创建后的管理

### 如果未预设阶段
创建大作业后，可以随时通过以下方式添加阶段：
1. 进入"查看分组情况"
2. 点击"阶段管理"按钮
3. 点击"添加阶段"创建新阶段

### 如果预设了阶段
创建后可以：
1. ✅ 查看已创建的阶段
2. ✅ 编辑阶段时间和描述
3. ✅ 添加更多阶段
4. ✅ 为分工阶段添加角色
5. ✅ 删除不需要的阶段

## 自动处理说明

### 组队阶段结束时
系统会：
1. 🔍 检查所有未组队的学生
2. 🎲 随机打乱学生顺序
3. 👥 创建新团队（命名为"XXX的团队（系统自动分配）"）
4. 🔒 自动确认并锁定团队
5. 📧 发送通知给所有受影响的学生

**示例**：
```
班级总人数：30人
已组队：24人（6个团队，每队4人）
未组队：6人

系统处理：
→ 创建团队1：张三的团队（张三、李四、王五）
→ 创建团队2：赵六的团队（赵六、钱七、孙八）
→ 所有团队自动确认并锁定
```

### 分工阶段结束时
系统会：
1. 🔍 检查所有未分配的"必须角色"
2. 🎲 从团队成员中随机选择
3. 👤 创建分配记录
4. 📧 发送通知给被分配的成员和组长

**示例**：
```
团队：前端开发小组
角色设置：
  - 项目经理（必须）→ 已分配：张三
  - 前端开发员（必须）→ 未分配
  - 后端开发员（必须）→ 未分配
  - 测试员（可选）→ 未分配

系统处理：
→ 随机选择李四担任"前端开发员"
→ 随机选择王五担任"后端开发员"
→ "测试员"为可选角色，不自动分配
→ 发送通知给李四、王五和组长张三
```

## 与后续管理的关系

### 阶段管理页面
创建后可以在阶段管理页面：
- ✅ 查看所有阶段
- ✅ 手动激活/完成阶段
- ✅ 更新阶段状态
- ✅ 管理分工角色

### 分工角色管理
对于分工阶段：
1. 创建后进入"阶段管理"
2. 找到分工阶段，点击"管理分工角色"
3. 添加具体的角色定义

### 学生视角
学生在大作业详情页可以看到：
- 📅 当前阶段状态
- 👥 组队信息
- 🎭 分工情况
- ⏰ 阶段截止时间

## 常见问题

**Q: 如果不勾选任何阶段会怎样？**
A: 大作业正常创建，但没有阶段。可以稍后在阶段管理中添加。

**Q: 可以同时勾选组队和分工阶段吗？**
A: 可以！系统会按顺序创建两个阶段（组队阶段order=1，分工阶段order=2）。

**Q: 创建后可以修改阶段时间吗？**
A: 可以，在阶段管理页面点击"编辑"即可修改。

**Q: 分工阶段创建后为什么没有角色？**
A: 需要进入"管理分工角色"页面手动添加角色定义。

**Q: 阶段会自动开始和结束吗？**
A: 是的，系统会根据设置的时间自动更新状态。也可以手动激活/完成。

**Q: 如果阶段时间超出大作业时间范围会怎样？**
A: 系统会拒绝创建并提示错误信息。

## 最佳实践

### ✅ 推荐做法
1. **合理规划时间**：给每个阶段留足够的时间
2. **先组队后分工**：组队阶段应该在分工阶段之前
3. **预留缓冲时间**：阶段之间留1-2天缓冲
4. **明确必须角色**：分工阶段创建后立即添加必须角色

### ❌ 避免做法
1. 阶段时间过短（少于3天）
2. 阶段时间重叠
3. 分工阶段在组队阶段之前
4. 阶段时间超出大作业时间范围

## 示例：完整创建流程

```
步骤1：基本信息
  标题：Web应用开发大作业
  描述：开发一个完整的Web应用系统
  班级：软件工程2023级1班
  人数：2-5人
  
步骤2：时间设置
  开始日期：2025-10-20 00:00
  结束日期：2025-12-31 23:59
  
步骤3：预设阶段
  ✅ 组队阶段
     开始：2025-10-20 00:00
     结束：2025-10-26 23:59
     
  ✅ 分工阶段  
     开始：2025-10-27 00:00
     结束：2025-11-02 23:59
     
步骤4：提交创建

步骤5：后续操作
  1. 进入"阶段管理"
  2. 为分工阶段添加角色：
     - 项目经理（必须）
     - 前端开发（必须）
     - 后端开发（必须）
     - UI设计（可选）
  3. 添加更多自定义阶段：
     - 需求分析阶段
     - 系统设计阶段
     - 编码实现阶段
     - 测试部署阶段
```

## 技术说明

### 数据存储
- 阶段数据存储在 `stage` 表
- 自动设置 `order` 字段（组队=1，分工=2）
- 时间自动转换为UTC存储，显示为北京时间

### 权限控制
- 只有教师和管理员可以创建大作业
- 超级管理员可以选择任意教师作为管理者
- 普通教师只能选择自己

### 通知机制
- 创建大作业时通知班级所有学生
- 阶段自动结束时通知受影响的学生
- 所有通知记录在通知系统中
