# 阶段管理系统使用说明

## 功能概述

TG-EDU系统的阶段管理功能允许教师为大作业设置不同的阶段，并自动处理相关逻辑。

## 阶段类型

### 1. 组队阶段 (Team Formation)
- **用途**：让学生自由组队
- **特性**：
  - 学生可以创建团队并邀请成员
  - 组长可以请求确认团队
  - 教师确认后团队被锁定
- **自动处理**：
  - 阶段结束时，系统会自动将未组队的学生随机分配到新团队
  - 自动创建的团队会被立即确认并锁定
  - 所有受影响的学生会收到通知

### 2. 分工阶段 (Division)
- **用途**：为团队成员分配具体角色
- **特性**：
  - 教师可以定义分工角色（如：项目经理、开发员、测试员）
  - 每个角色可以设置为"必须"或"可选"
  - 组长为团队成员分配角色
- **自动处理**：
  - 阶段结束时，系统会自动为未分配的"必须角色"随机分配成员
  - 一个成员可以担任多个角色
  - 所有受影响的成员会收到通知

### 3. 自定义阶段 (Custom)
- **用途**：标记大作业的里程碑或其他重要节点
- **特性**：
  - 灵活设置阶段名称和描述
  - 可用于跟踪项目进度
- **自动处理**：无特殊自动处理逻辑

## 操作流程

### 教师端操作

#### 1. 设置大作业时间范围
1. 编辑大作业
2. 设置"开始日期"和"结束日期"
3. 所有阶段必须在这个时间范围内

#### 2. 创建阶段
1. 进入大作业 → 查看分组情况 → 阶段管理
2. 点击"添加阶段"
3. 填写阶段信息：
   - 阶段名称（例如：组队阶段、分工阶段）
   - 阶段类型（选择对应类型）
   - 阶段描述（可选）
   - 开始时间和结束时间
4. 点击"创建阶段"

#### 3. 管理分工角色（仅分工阶段）
1. 在阶段列表中找到分工阶段
2. 点击"管理分工角色"
3. 添加角色：
   - 角色名称（例如：项目经理）
   - 角色描述（说明职责）
   - 是否必须（勾选表示每个团队必须分配此角色）
4. 可以编辑或删除角色

#### 4. 控制阶段状态
有三种方式更新阶段状态：

**方式1：自动更新（推荐）**
- 系统会根据开始/结束时间自动更新状态
- 可以点击"更新阶段状态"按钮手动触发

**方式2：手动激活**
- 对于"待开始"的阶段，点击"立即激活"

**方式3：手动完成**
- 对于"进行中"的阶段，点击"立即结束"
- 会立即执行自动处理逻辑

#### 5. 查看进度
- 在"查看分组情况"页面可以看到：
  - 团队总数、已确认、待确认
  - 已组队学生数
  - 所有阶段的当前状态

### 学生端操作

#### 1. 组队阶段
1. 进入大作业详情页
2. 点击"创建团队"成为组长，或等待他人邀请
3. 组长可以：
   - 邀请成员（填写姓名和学号）
   - 查看邀请记录
   - 请求确认团队
4. 成员可以：
   - 接受或拒绝邀请
   - 申请退组

#### 2. 分工阶段
1. 在团队详情页查看"团队分工"卡片
2. 组长点击"分配角色"
3. 为每个角色选择负责人
4. 必须角色必须分配，可选角色可以不分配
5. 保存后可以随时修改（团队锁定前）

#### 3. 查看组队阶段信息
- 在团队详情页可以看到组队阶段的状态
- 了解阶段结束时间
- 如果阶段进行中，会提示未组队学生将被自动分组

## 阶段状态说明

- **待开始 (Pending)**：还未到开始时间
- **进行中 (Active)**：已开始但未结束
- **已完成 (Completed)**：已结束并执行了自动处理

## 自动处理时机

### 自动触发（需要配置定时任务）
```bash
# 在服务器上设置cron任务，每小时执行一次
0 * * * * cd /app && python3 update_stage_status.py
```

### 手动触发
- 教师在阶段管理页面点击"更新阶段状态"
- 教师点击"立即结束"按钮

## 通知机制

系统会在以下情况发送通知：
1. 组长请求确认团队 → 通知所有管理教师
2. 教师确认团队 → 通知组长和所有成员
3. 系统自动分组 → 通知被分配的学生
4. 系统自动分配角色 → 通知被分配的成员和组长

## 注意事项

1. **时间设置**：
   - 所有阶段必须在大作业的开始和结束日期之间
   - 建议合理安排各阶段时间，避免重叠

2. **团队锁定**：
   - 教师确认后团队会被锁定
   - 锁定后学生无法调整成员和分工
   - 只有教师可以调整锁定的团队

3. **自动分组**：
   - 组队阶段结束时才会自动分组
   - 系统会尽量满足最小人数要求
   - 自动创建的团队会被立即锁定

4. **角色分配**：
   - 必须角色必须全部分配后才能保存
   - 分工阶段结束后，未分配的必须角色会被随机分配
   - 一个成员可以担任多个角色

5. **阶段顺序**：
   - 建议按照：组队阶段 → 分工阶段 → 自定义阶段
   - 可以创建多个同类型阶段

## 常见问题

**Q: 如何撤销阶段的完成状态？**
A: 目前无法直接撤销，需要删除阶段并重新创建。建议谨慎使用"立即结束"功能。

**Q: 学生没有组队怎么办？**
A: 组队阶段结束时，系统会自动为未组队的学生创建团队并分配。

**Q: 如何修改已确认的团队？**
A: 教师可以在"查看分组情况"页面使用"管理"功能调整团队成员。

**Q: 分工阶段没有创建角色会怎样？**
A: 如果没有创建任何角色，分工阶段结束时不会执行任何自动处理。

**Q: 能否在阶段进行中修改开始/结束时间？**
A: 可以在阶段管理页面编辑阶段来修改时间。

## 技术支持

如有问题请联系系统管理员。
